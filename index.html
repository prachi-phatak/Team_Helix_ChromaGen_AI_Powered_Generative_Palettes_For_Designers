<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChromaGen - AI Color Palette Generator</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🎨</text></svg>" />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Color Blindness Indicator -->
  <div class="cb-indicator" id="cb-indicator">
    Normal Vision
  </div>

  <!-- Processing Notification -->
  <div class="processing-notification" id="processing-notification">
    <div class="spinner" style="margin-bottom: 20px;"></div>
    <h3>🎨 Analyzing Your Image</h3>
    <p>Extracting 14+ colors and calculating comprehensive WCAG accessibility metrics...</p>
  </div>

  <div class="container">
    <header id="main-header">
      <h1 class="fgh">🎨 ChromaGen</h1>
      <p class="abc">AI-Powered Color Palette Generator for Designers </p>
    </header>

    <main class="main-content" id="main-content">
      <div class="flex-row">
        <!-- Input Section -->
        <section class="input-section" aria-label="Palette generation inputs">
          <h2 class="section-title">
            <span>✨</span> Create Your Palette
          </h2>
          
          <nav class="tabs" role="tablist" aria-label="Input type selection" id="input-tabs">
            <button class="tab active" role="tab" aria-selected="true" id="text-tab-btn">
              📝 Text Prompt
            </button>
            <button class="tab" role="tab" aria-selected="false" id="image-tab-btn">
              🖼 Image Upload
            </button>
          </nav>

          <div role="tabpanel" id="text-tab" aria-labelledby="text-tab-btn">
            <label for="text-prompt" style="font-weight: 600; margin-bottom: 12px; display: block; color: #2c3e50;">
              Describe your creative vision:
            </label>
            <textarea 
              id="text-prompt" 
              placeholder="Create an energetic palette for a fitness brand inspired by a tropical sunset with vibrant oranges and calming blues..."
              rows="5"
            ></textarea>
            <div style="margin-top: 15px; font-size: 0.95rem; color: #6c757d;">
              ✨ Try these inspiring examples: 
              <div style="margin-top: 10px;">
                <button type="button" class="example-tag">🧘 Calming Spa Retreat</button>
                <button type="button" class="example-tag">🚀 Tech Startup Energy</button>
                <button type="button" class="example-tag">🍂 Cozy Autumn Café</button>
                <button type="button" class="example-tag">🌊 Ocean Depth Mystery</button>
                <button type="button" class="example-tag">🌅 Sunrise Meditation</button>
              </div>
            </div>
          </div>

          <div role="tabpanel" id="image-tab" aria-labelledby="image-tab-btn" hidden>
            <label style="font-weight: 600; margin-bottom: 12px; display: block; color: #2c3e50;">
              Upload inspiration image:
            </label>
            <div class="image-upload" id="image-upload" tabindex="0" role="button">
              <div class="icon">📸</div>
              <p><strong>Click or drag & drop your image</strong></p>
              <small>JPG, PNG up to 10MB • Extract 14+ colors from photos, artwork, or designs</small>
              <input type="file" id="image-input" accept="image/jpeg,image/png,image/jpg" />
            </div>
            <div id="image-info" style="margin-top: 15px; font-size: 0.9rem; color: #6c757d; display: none;">
              <p><strong>✅ Image loaded:</strong> <span id="image-name"></span></p>
              <p><strong>📏 Dimensions:</strong> <span id="image-dimensions"></span></p>
              <p><strong>🎨 Ready for analysis:</strong> 14+ colors with full WCAG accessibility metrics</p>
            </div>
          </div>

          <div class="loading" id="loading">
            <div class="spinner"></div>
            <p><strong>🎨 Generating your perfect palette...</strong></p>
            <small>Analyzing colors and ensuring WCAG accessibility compliance</small>
          </div>

          <button class="generate-btn" id="generate-btn">
            🚀 Generate Palette
          </button>
        </section>

        <!-- Palette & Results Section -->
        <section class="palette-section">
          <div class="cb-selector">
            <label for="cb-sim">👁 Color Blindness Simulation:</label>
            <select id="cb-sim" aria-label="Select color blindness simulation type">
              <option value="normal">👁 Normal Vision</option>
              <option value="deuteranopia">🟢 Deuteranopia (Green-blind)</option>
              <option value="protanopia">🔴 Protanopia (Red-blind)</option>
              <option value="tritanopia">🔵 Tritanopia (Blue-blind)</option>
              <option value="monochromacy">⚫ Monochromacy (Grayscale)</option>
            </select>
          </div>

          <h2 class="palette-header">🎨 Your Generated Palette</h2>
          
          <div class="palette-info" id="palette-info" style="display: none;">
            <span id="palette-info-text">14 colors generated with HEX, RGB, HSL values and comprehensive WCAG analysis</span>
          </div>

          <div class="palette-controls" id="palette-controls" style="display: none;">
            <button class="save-json-btn" id="save-json-btn">
              <span>💾</span>
              <span>Export as JSON</span>
            </button>
          </div>

          <div class="color-palette" id="color-palette">
            <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #6c757d;">
              <div style="font-size: 3rem; margin-bottom: 15px;">🎨</div>
              <h3 style="color: #2c3e50; margin-bottom: 10px;">Ready to Create Amazing Palettes</h3>
              <p>Generate from text prompts or upload images to extract 14+ colors with HEX, RGB and HSL values and full WCAG accessibility analysis</p>
            </div>
          </div>
        </section>
      </div>

      <!-- Accessibility Analysis Section -->
      <section class="accessibility-section" id="accessibility-section" hidden>
        <h3 class="accessibility-header">
          <span>♿</span> Comprehensive WCAG Accessibility Analysis
        </h3>
        
        <!-- Image Analysis Section (shown only for uploaded images) -->
        <div class="image-analysis" id="image-analysis" style="display: none;">
          <h4>📊 Image Color Analysis</h4>
          <div class="image-stats" id="image-stats">
            <!-- Dynamic image statistics will be inserted here -->
          </div>
        </div>

        <!-- Enhanced WCAG Analysis Section for Images -->
        <div class="wcag-analysis" id="wcag-analysis" style="display: none;">
          <h4>📋 WCAG Compliance Summary</h4>
          <div class="wcag-summary" id="wcag-summary">
            <!-- Dynamic WCAG compliance statistics will be inserted here -->
          </div>
        </div>

        <div class="accessibility-grid">
          <div class="contrast-checker">
            <h4 style="margin-bottom: 20px; color: #2c3e50; font-size: 1.3rem;">
              📊 Detailed WCAG Contrast Analysis
            </h4>
            <div id="contrast-results">
              <div style="text-align: center; padding: 40px; color: #6c757d;">
                <div style="font-size: 2rem; margin-bottom: 10px;">📊</div>
                <p>Detailed contrast analysis will appear here after generating a palette</p>
              </div>
            </div>
          </div>
          
          <div class="colorblind-simulation">
            <h4 style="margin-bottom: 20px; color: #2c3e50; font-size: 1.3rem;">
              👁 Color Vision Simulations
            </h4>
            <div class="simulation-types">
              <div class="simulation-type">
                <h4>Deuteranopia</h4>
                <div class="mini-palette" id="deuteranopia-palette">
                  <div style="text-align: center; padding: 10px; color: #6c757d; font-size: 0.8rem;">
                    Generate palette first
                  </div>
                </div>
              </div>
              <div class="simulation-type">
                <h4>Protanopia</h4>
                <div class="mini-palette" id="protanopia-palette">
                  <div style="text-align: center; padding: 10px; color: #6c757d; font-size: 0.8rem;">
                    Generate palette first
                  </div>
                </div>
              </div>
              <div class="simulation-type">
                <h4>Tritanopia</h4>
                <div class="mini-palette" id="tritanopia-palette">
                  <div style="text-align: center; padding: 10px; color: #6c757d; font-size: 0.8rem;">
                    Generate palette first
                  </div>
                </div>
              </div>
              <div class="simulation-type">
                <h4>Monochromacy</h4>
                <div class="mini-palette" id="monochromacy-palette">
                  <div style="text-align: center; padding: 10px; color: #6c757d; font-size: 0.8rem;">
                    Generate palette first
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Copy Notification -->
  <div id="copy-notification" role="alert">
    🎉 Color code copied to clipboard!
  </div>

  <script>
    // Main Application Controller
    (function() {
      'use strict';
      
      // DOM Elements
      const elements = {
        body: document.body,
        header: document.getElementById('main-header'),
        mainContent: document.getElementById('main-content'),
        inputTabs: document.getElementById('input-tabs'),
        textTab: document.getElementById('text-tab'),
        imageTab: document.getElementById('image-tab'),
        textPrompt: document.getElementById('text-prompt'),
        imageInput: document.getElementById('image-input'),
        imageUpload: document.getElementById('image-upload'),
        imageInfo: document.getElementById('image-info'),
        imageName: document.getElementById('image-name'),
        imageDimensions: document.getElementById('image-dimensions'),
        generateBtn: document.getElementById('generate-btn'),
        loading: document.getElementById('loading'),
        processingNotification: document.getElementById('processing-notification'),
        colorPalette: document.getElementById('color-palette'),
        paletteInfo: document.getElementById('palette-info'),
        paletteInfoText: document.getElementById('palette-info-text'),
        paletteControls: document.getElementById('palette-controls'),
        saveJsonBtn: document.getElementById('save-json-btn'),
        contrastResults: document.getElementById('contrast-results'),
        accessibilitySection: document.getElementById('accessibility-section'),
        imageAnalysis: document.getElementById('image-analysis'),
        imageStats: document.getElementById('image-stats'),
        wcagAnalysis: document.getElementById('wcag-analysis'),
        wcagSummary: document.getElementById('wcag-summary'),
        cbSimSelect: document.getElementById('cb-sim'),
        cbIndicator: document.getElementById('cb-indicator'),
        copyNotification: document.getElementById('copy-notification')
      };

      // Application State
      let state = {
        activeTab: 'text',
        currentPalette: [],
        cbMode: 'normal',
        isGenerating: false,
        uploadedImageData: null,
        isImageUpload: false,
        imageAnalysisData: null,
        wcagCompliance: null,
        paletteMetadata: {}
      };

      // Enhanced Color Palette Templates with RGB and HSL values
      const paletteTemplates = {
        spa: [
          {
            hex: '#0277bd', 
            rgb: {r: 2, g: 119, b: 189}, 
            hsl: {h: 202, s: 97, l: 37}, 
            role: 'Primary', 
            name: 'Ocean Blue'
          },
          {
            hex: '#26c6da', 
            rgb: {r: 38, g: 198, b: 218}, 
            hsl: {h: 187, s: 70, l: 50}, 
            role: 'Secondary', 
            name: 'Aqua Cyan'
          },
          {
            hex: '#66bb6a', 
            rgb: {r: 102, g: 187, b: 106}, 
            hsl: {h: 123, s: 38, l: 57}, 
            role: 'Accent 1', 
            name: 'Soft Green'
          },
          {
            hex: '#ab47bc', 
            rgb: {r: 171, g: 71, b: 188}, 
            hsl: {h: 291, s: 48, l: 51}, 
            role: 'Accent 2', 
            name: 'Zen Purple'
          },
          {
            hex: '#4fc3f7', 
            rgb: {r: 79, g: 195, b: 247}, 
            hsl: {h: 199, s: 90, l: 64}, 
            role: 'Accent 3', 
            name: 'Sky Blue'
          },
          {
            hex: '#81c784', 
            rgb: {r: 129, g: 199, b: 132}, 
            hsl: {h: 123, s: 39, l: 64}, 
            role: 'Accent 4', 
            name: 'Mint Green'
          },
          {
            hex: '#e0f2f1', 
            rgb: {r: 224, g: 242, b: 241}, 
            hsl: {h: 177, s: 42, l: 91}, 
            role: 'Neutral', 
            name: 'Serenity Mint'
          },
          {
            hex: '#f1f8e9', 
            rgb: {r: 241, g: 248, b: 233}, 
            hsl: {h: 88, s: 50, l: 94}, 
            role: 'Light 1', 
            name: 'Pure White'
          },
          {
            hex: '#e8f5e8', 
            rgb: {r: 232, g: 245, b: 232}, 
            hsl: {h: 120, s: 38, l: 93}, 
            role: 'Light 2', 
            name: 'Soft Green Tint'
          },
          {
            hex: '#e3f2fd', 
            rgb: {r: 227, g: 242, b: 253}, 
            hsl: {h: 205, s: 81, l: 94}, 
            role: 'Light 3', 
            name: 'Cloud Blue'
          },
          {
            hex: '#37474f', 
            rgb: {r: 55, g: 71, b: 79}, 
            hsl: {h: 200, s: 18, l: 26}, 
            role: 'Dark 1', 
            name: 'Charcoal'
          },
          {
            hex: '#455a64', 
            rgb: {r: 69, g: 90, b: 100}, 
            hsl: {h: 199, s: 18, l: 33}, 
            role: 'Dark 2', 
            name: 'Slate Gray'
          },
          {
            hex: '#2e7d32', 
            rgb: {r: 46, g: 125, b: 50}, 
            hsl: {h: 123, s: 46, l: 34}, 
            role: 'Supporting', 
            name: 'Forest Green'
          },
          {
            hex: '#01579b', 
            rgb: {r: 1, g: 87, b: 155}, 
            hsl: {h: 207, s: 99, l: 31}, 
            role: 'Supporting 2', 
            name: 'Deep Blue'
          }
        ],

        tech: [
          {
            hex: '#1565c0', 
            rgb: {r: 21, g: 101, b: 192}, 
            hsl: {h: 212, s: 80, l: 42}, 
            role: 'Primary', 
            name: 'Electric Blue'
          },
          {
            hex: '#ff6f00', 
            rgb: {r: 255, g: 111, b: 0}, 
            hsl: {h: 26, s: 100, l: 50}, 
            role: 'Secondary', 
            name: 'Tech Orange'
          },
          {
            hex: '#00838f', 
            rgb: {r: 0, g: 131, b: 143}, 
            hsl: {h: 185, s: 100, l: 28}, 
            role: 'Accent 1', 
            name: 'Cyber Teal'
          },
          {
            hex: '#7b1fa2', 
            rgb: {r: 123, g: 31, b: 162}, 
            hsl: {h: 282, s: 68, l: 38}, 
            role: 'Accent 2', 
            name: 'Digital Purple'
          },
          {
            hex: '#1976d2', 
            rgb: {r: 25, g: 118, b: 210}, 
            hsl: {h: 210, s: 79, l: 46}, 
            role: 'Accent 3', 
            name: 'Blue Steel'
          },
          {
            hex: '#388e3c', 
            rgb: {r: 56, g: 142, b: 60}, 
            hsl: {h: 123, s: 43, l: 39}, 
            role: 'Accent 4', 
            name: 'Matrix Green'
          },
          {
            hex: '#eceff1', 
            rgb: {r: 236, g: 239, b: 241}, 
            hsl: {h: 204, s: 14, l: 93}, 
            role: 'Neutral', 
            name: 'Tech Gray'
          },
          {
            hex: '#f3e5f5', 
            rgb: {r: 243, g: 229, b: 245}, 
            hsl: {h: 292, s: 41, l: 93}, 
            role: 'Light 1', 
            name: 'Soft Lavender'
          },
          {
            hex: '#e0f2f1', 
            rgb: {r: 224, g: 242, b: 241}, 
            hsl: {h: 177, s: 42, l: 91}, 
            role: 'Light 2', 
            name: 'Cool Mint'
          },
          {
            hex: '#fff3e0', 
            rgb: {r: 255, g: 243, b: 224}, 
            hsl: {h: 37, s: 100, l: 94}, 
            role: 'Light 3', 
            name: 'Warm White'
          },
          {
            hex: '#263238', 
            rgb: {r: 38, g: 50, b: 56}, 
            hsl: {h: 200, s: 19, l: 18}, 
            role: 'Dark 1', 
            name: 'Code Black'
          },
          {
            hex: '#37474f', 
            rgb: {r: 55, g: 71, b: 79}, 
            hsl: {h: 200, s: 18, l: 26}, 
            role: 'Dark 2', 
            name: 'Terminal Gray'
          },
          {
            hex: '#0d47a1', 
            rgb: {r: 13, g: 71, b: 161}, 
            hsl: {h: 216, s: 85, l: 34}, 
            role: 'Supporting', 
            name: 'Deep Tech Blue'
          },
          {
            hex: '#e65100', 
            rgb: {r: 230, g: 81, b: 0}, 
            hsl: {h: 21, s: 100, l: 45}, 
            role: 'Supporting 2', 
            name: 'Alert Orange'
          }
        ],

        autumn: [
          {
            hex: '#d84315', 
            rgb: {r: 216, g: 67, b: 21}, 
            hsl: {h: 14, s: 82, l: 46}, 
            role: 'Primary', 
            name: 'Autumn Red'
          },
          {
            hex: '#ff8f00', 
            rgb: {r: 255, g: 143, b: 0}, 
            hsl: {h: 34, s: 100, l: 50}, 
            role: 'Secondary', 
            name: 'Golden Yellow'
          },
          {
            hex: '#689f38', 
            rgb: {r: 104, g: 159, b: 56}, 
            hsl: {h: 92, s: 48, l: 42}, 
            role: 'Accent 1', 
            name: 'Olive Green'
          },
          {
            hex: '#512da8', 
            rgb: {r: 81, g: 45, b: 168}, 
            hsl: {h: 258, s: 58, l: 42}, 
            role: 'Accent 2', 
            name: 'Plum Purple'
          },
          {
            hex: '#ff6f00', 
            rgb: {r: 255, g: 111, b: 0}, 
            hsl: {h: 26, s: 100, l: 50}, 
            role: 'Accent 3', 
            name: 'Burnt Orange'
          },
          {
            hex: '#8bc34a', 
            rgb: {r: 139, g: 195, b: 74}, 
            hsl: {h: 88, s: 51, l: 53}, 
            role: 'Accent 4', 
            name: 'Leaf Green'
          },
          {
            hex: '#efebe9', 
            rgb: {r: 239, g: 235, b: 233}, 
            hsl: {h: 20, s: 17, l: 93}, 
            role: 'Neutral', 
            name: 'Warm Beige'
          },
          {
            hex: '#fff3e0', 
            rgb: {r: 255, g: 243, b: 224}, 
            hsl: {h: 37, s: 100, l: 94}, 
            role: 'Light 1', 
            name: 'Cream'
          },
          {
            hex: '#f3e5f5', 
            rgb: {r: 243, g: 229, b: 245}, 
            hsl: {h: 292, s: 41, l: 93}, 
            role: 'Light 2', 
            name: 'Soft Purple'
          },
          {
            hex: '#f1f8e9', 
            rgb: {r: 241, g: 248, b: 233}, 
            hsl: {h: 88, s: 50, l: 94}, 
            role: 'Light 3', 
            name: 'Light Green'
          },
          {
            hex: '#3e2723', 
            rgb: {r: 62, g: 39, b: 35}, 
            hsl: {h: 9, s: 28, l: 19}, 
            role: 'Dark 1', 
            name: 'Coffee Brown'
          },
          {
            hex: '#5d4037', 
            rgb: {r: 93, g: 64, b: 55}, 
            hsl: {h: 14, s: 26, l: 29}, 
            role: 'Dark 2', 
            name: 'Cocoa'
          },
          {
            hex: '#bf360c', 
            rgb: {r: 191, g: 54, b: 12}, 
            hsl: {h: 14, s: 88, l: 40}, 
            role: 'Supporting', 
            name: 'Rust Red'
          },
          {
            hex: '#827717', 
            rgb: {r: 130, g: 119, b: 23}, 
            hsl: {h: 54, s: 70, l: 30}, 
            role: 'Supporting 2', 
            name: 'Autumn Gold'
          }
        ],

        ocean: [
          {
            hex: '#006064', 
            rgb: {r: 0, g: 96, b: 100}, 
            hsl: {h: 182, s: 100, l: 20}, 
            role: 'Primary', 
            name: 'Deep Ocean'
          },
          {
            hex: '#0288d1', 
            rgb: {r: 2, g: 136, b: 209}, 
            hsl: {h: 201, s: 98, l: 41}, 
            role: 'Secondary', 
            name: 'Wave Blue'
          },
          {
            hex: '#26a69a', 
            rgb: {r: 38, g: 166, b: 154}, 
            hsl: {h: 174, s: 63, l: 40}, 
            role: 'Accent 1', 
            name: 'Turquoise'
          },
          {
            hex: '#5e35b1', 
            rgb: {r: 94, g: 53, b: 177}, 
            hsl: {h: 260, s: 54, l: 45}, 
            role: 'Accent 2', 
            name: 'Deep Purple'
          },
          {
            hex: '#00acc1', 
            rgb: {r: 0, g: 172, b: 193}, 
            hsl: {h: 187, s: 100, l: 38}, 
            role: 'Accent 3', 
            name: 'Aqua'
          },
          {
            hex: '#4db6ac', 
            rgb: {r: 77, g: 182, b: 172}, 
            hsl: {h: 174, s: 42, l: 51}, 
            role: 'Accent 4', 
            name: 'Sea Green'
          },
          {
            hex: '#e0f7fa', 
            rgb: {r: 224, g: 247, b: 250}, 
            hsl: {h: 187, s: 68, l: 93}, 
            role: 'Neutral', 
            name: 'Sea Foam'
          },
          {
            hex: '#f1f8e9', 
            rgb: {r: 241, g: 248, b: 233}, 
            hsl: {h: 88, s: 50, l: 94}, 
            role: 'Light 1', 
            name: 'Pearl White'
          },
          {
            hex: '#e8f5e8', 
            rgb: {r: 232, g: 245, b: 232}, 
            hsl: {h: 120, s: 38, l: 93}, 
            role: 'Light 2', 
            name: 'Mint Foam'
          },
          {
            hex: '#e3f2fd', 
            rgb: {r: 227, g: 242, b: 253}, 
            hsl: {h: 205, s: 81, l: 94}, 
            role: 'Light 3', 
            name: 'Sky Reflection'
          },
          {
            hex: '#37474f', 
            rgb: {r: 55, g: 71, b: 79}, 
            hsl: {h: 200, s: 18, l: 26}, 
            role: 'Dark 1', 
            name: 'Depth Gray'
          },
          {
            hex: '#263238', 
            rgb: {r: 38, g: 50, b: 56}, 
            hsl: {h: 200, s: 19, l: 18}, 
            role: 'Dark 2', 
            name: 'Abyss'
          },
          {
            hex: '#004d40', 
            rgb: {r: 0, g: 77, b: 64}, 
            hsl: {h: 170, s: 100, l: 15}, 
            role: 'Supporting', 
            name: 'Marine Green'
          },
          {
            hex: '#01579b', 
            rgb: {r: 1, g: 87, b: 155}, 
            hsl: {h: 207, s: 99, l: 31}, 
            role: 'Supporting 2', 
            name: 'Midnight Blue'
          }
        ],

        sunrise: [
          {
            hex: '#e65100', 
            rgb: {r: 230, g: 81, b: 0}, 
            hsl: {h: 21, s: 100, l: 45}, 
            role: 'Primary', 
            name: 'Dawn Orange'
          },
          {
            hex: '#ffc107', 
            rgb: {r: 255, g: 193, b: 7}, 
            hsl: {h: 45, s: 100, l: 51}, 
            role: 'Secondary', 
            name: 'Solar Yellow'
          },
          {
            hex: '#8bc34a', 
            rgb: {r: 139, g: 195, b: 74}, 
            hsl: {h: 88, s: 51, l: 53}, 
            role: 'Accent 1', 
            name: 'Morning Green'
          },
          {
            hex: '#9c27b0', 
            rgb: {r: 156, g: 39, b: 176}, 
            hsl: {h: 291, s: 64, l: 42}, 
            role: 'Accent 2', 
            name: 'Twilight Purple'
          },
          {
            hex: '#ff5722', 
            rgb: {r: 255, g: 87, b: 34}, 
            hsl: {h: 14, s: 100, l: 57}, 
            role: 'Accent 3', 
            name: 'Fire Red'
          },
          {
            hex: '#ffb300', 
            rgb: {r: 255, g: 179, b: 0}, 
            hsl: {h: 42, s: 100, l: 50}, 
            role: 'Accent 4', 
            name: 'Amber Gold'
          },
          {
            hex: '#fff3e0', 
            rgb: {r: 255, g: 243, b: 224}, 
            hsl: {h: 37, s: 100, l: 94}, 
            role: 'Neutral', 
            name: 'Sunrise Glow'
          },
          {
            hex: '#f9fbe7', 
            rgb: {r: 249, g: 251, b: 231}, 
            hsl: {h: 66, s: 67, l: 95}, 
            role: 'Light 1', 
            name: 'Morning Light'
          },
          {
            hex: '#fce4ec', 
            rgb: {r: 252, g: 228, b: 236}, 
            hsl: {h: 340, s: 75, l: 94}, 
            role: 'Light 2', 
            name: 'Rose Dawn'
          },
          {
            hex: '#fff8e1', 
            rgb: {r: 255, g: 248, b: 225}, 
            hsl: {h: 46, s: 100, l: 94}, 
            role: 'Light 3', 
            name: 'Golden Hour'
          },
          {
            hex: '#bf360c', 
            rgb: {r: 191, g: 54, b: 12}, 
            hsl: {h: 14, s: 88, l: 40}, 
            role: 'Dark 1', 
            name: 'Ember'
          },
          {
            hex: '#e65100', 
            rgb: {r: 230, g: 81, b: 0}, 
            hsl: {h: 21, s: 100, l: 45}, 
            role: 'Dark 2', 
            name: 'Sunset Deep'
          },
          {
            hex: '#ff6f00', 
            rgb: {r: 255, g: 111, b: 0}, 
            hsl: {h: 26, s: 100, l: 50}, 
            role: 'Supporting', 
            name: 'Solar Flare'
          },
          {
            hex: '#f57f17', 
            rgb: {r: 245, g: 127, b: 23}, 
            hsl: {h: 28, s: 91, l: 53}, 
            role: 'Supporting 2', 
            name: 'Citrus'
          }
        ],

        default: [
          {
            hex: '#1976d2', 
            rgb: {r: 25, g: 118, b: 210}, 
            hsl: {h: 210, s: 79, l: 46}, 
            role: 'Primary', 
            name: 'Classic Blue'
          },
          {
            hex: '#ffb300', 
            rgb: {r: 255, g: 179, b: 0}, 
            hsl: {h: 42, s: 100, l: 50}, 
            role: 'Secondary', 
            name: 'Warm Gold'
          },
          {
            hex: '#00acc1', 
            rgb: {r: 0, g: 172, b: 193}, 
            hsl: {h: 187, s: 100, l: 38}, 
            role: 'Accent 1', 
            name: 'Fresh Cyan'
          },
          {
            hex: '#ab47bc', 
            rgb: {r: 171, g: 71, b: 188}, 
            hsl: {h: 291, s: 48, l: 51}, 
            role: 'Accent 2', 
            name: 'Royal Purple'
          },
          {
            hex: '#4caf50', 
            rgb: {r: 76, g: 175, b: 80}, 
            hsl: {h: 122, s: 39, l: 49}, 
            role: 'Accent 3', 
            name: 'Success Green'
          },
          {
            hex: '#ff9800', 
            rgb: {r: 255, g: 152, b: 0}, 
            hsl: {h: 36, s: 100, l: 50}, 
            role: 'Accent 4', 
            name: 'Energy Orange'
          },
          {
            hex: '#f5f5f5', 
            rgb: {r: 245, g: 245, b: 245}, 
            hsl: {h: 0, s: 0, l: 96}, 
            role: 'Neutral', 
            name: 'Clean Gray'
          },
          {
            hex: '#fafafa', 
            rgb: {r: 250, g: 250, b: 250}, 
            hsl: {h: 0, s: 0, l: 98}, 
            role: 'Light 1', 
            name: 'Pure White'
          },
          {
            hex: '#f0f4f8', 
            rgb: {r: 240, g: 244, b: 248}, 
            hsl: {h: 210, s: 29, l: 96}, 
            role: 'Light 2', 
            name: 'Cool White'
          },
          {
            hex: '#fff9c4', 
            rgb: {r: 255, g: 249, b: 196}, 
            hsl: {h: 54, s: 100, l: 88}, 
            role: 'Light 3', 
            name: 'Soft Yellow'
          },
          {
            hex: '#212121', 
            rgb: {r: 33, g: 33, b: 33}, 
            hsl: {h: 0, s: 0, l: 13}, 
            role: 'Dark 1', 
            name: 'True Black'
          },
          {
            hex: '#424242', 
            rgb: {r: 66, g: 66, b: 66}, 
            hsl: {h: 0, s: 0, l: 26}, 
            role: 'Dark 2', 
            name: 'Charcoal'
          },
          {
            hex: '#1565c0', 
            rgb: {r: 21, g: 101, b: 192}, 
            hsl: {h: 212, s: 80, l: 42}, 
            role: 'Supporting', 
            name: 'Deep Blue'
          },
          {
            hex: '#2e7d32', 
            rgb: {r: 46, g: 125, b: 50}, 
            hsl: {h: 123, s: 46, l: 34}, 
            role: 'Supporting 2', 
            name: 'Forest Green'
          }
        ]
      };

      // Color Blindness Simulation Functions
      const colorBlindness = {
        simulateDeuteranopia: ({r, g, b}) => ({
          r: 0.625 * r + 0.375 * g,
          g: 0.7 * r + 0.3 * g,
          b: 0.3 * g + 0.7 * b
        }),
        
        simulateProtanopia: ({r, g, b}) => ({
          r: 0.567 * r + 0.433 * g,
          g: 0.558 * r + 0.442 * g,
          b: 0.242 * g + 0.758 * b
        }),
        
        simulateTritanopia: ({r, g, b}) => ({
          r: 0.95 * r + 0.05 * g,
          g: 0.433 * g + 0.567 * b,
          b: 0.475 * g + 0.525 * b
        }),
        
        simulateMonochromacy: ({r, g, b}) => {
          const gray = 0.299 * r + 0.587 * g + 0.114 * b;
          return {r: gray, g: gray, b: gray};
        }
      };

      // Background and UI Color Transformation
      function updateFullUIForColorBlindness(mode) {
        const modeNames = {
          normal: '👁 Normal Vision',
          deuteranopia: '🟢 Deuteranopia (Green-blind)',
          protanopia: '🔴 Protanopia (Red-blind)',
          tritanopia: '🔵 Tritanopia (Blue-blind)',
          monochromacy: '⚫ Monochromacy (Grayscale)'
        };

        // Update indicator
        elements.cbIndicator.textContent = modeNames[mode] || modeNames.normal;
        elements.cbIndicator.classList.toggle('show', mode !== 'normal');

        // Apply transformations based on color blindness type
        switch(mode) {
          case 'normal':
            applyNormalTheme();
            break;
          case 'deuteranopia':
            applyDeuteranopiatheme();
            break;
          case 'protanopia':
            applyProtanopiaTheme();
            break;
          case 'tritanopia':
            applyTritanopiaTheme();
            break;
          case 'monochromacy':
            applyMonochromacyTheme();
            break;
        }

        // Update current palette display
        if (state.currentPalette.length > 0) {
          displayPalette(state.currentPalette);
        }
      }

      function applyNormalTheme() {
        elements.body.style.background = 'linear-gradient(135deg, #304ffe 0%, #bdbdbd 100%)';
        elements.header.style.background = 'linear-gradient(135deg, #1976d2 0%, #ffb300 25%, #42a5f5 50%, #ab47bc 75%, #e91e63 100%)';
        elements.mainContent.style.background = 'linear-gradient(145deg, #f8f9fa 0%, #ffffff 50%, #f8f9fa 100%)';
      }

      function applyDeuteranopiatheme() {
        elements.body.style.background = 'linear-gradient(135deg, #7b88d7 0%, #c7c7a3 100%)';
        elements.header.style.background = 'linear-gradient(135deg, #6b7bd6 0%, #e8c547 25%, #5a9bd4 50%, #9f5fb5 75%, #d4457a 100%)';
        elements.mainContent.style.background = 'linear-gradient(145deg, #f5f5f0 0%, #fefefe 50%, #f5f5f0 100%)';
      }

      function applyProtanopiaTheme() {
        elements.body.style.background = 'linear-gradient(135deg, #7887d8 0%, #d9cfb5 100%)';
        elements.header.style.background = 'linear-gradient(135deg, #4a6bd8 0%, #c7a547 25%, #4a9bd4 50%, #8f5fb5 75%, #7a457a 100%)';
        elements.mainContent.style.background = 'linear-gradient(145deg, #f2f5f0 0%, #fefefe 50%, #f2f5f0 100%)';
      }

      function applyTritanopiaTheme() {
        elements.body.style.background = 'linear-gradient(135deg, #a1a152 0%, #bdb9b8 100%)';
        elements.header.style.background = 'linear-gradient(135deg, #8f9152 0%, #d4a547 25%, #6fa152 50%, #9f5f85 75%, #d44575 100%)';
        elements.mainContent.style.background = 'linear-gradient(145deg, #f5f2f0 0%, #fefefe 50%, #f5f2f0 100%)';
      }

      function applyMonochromacyTheme() {
        elements.body.style.background = 'linear-gradient(135deg, #bbbbbb 0%, #eeeeee 100%)';
        elements.header.style.background = 'linear-gradient(135deg, #888888 0%, #aaaaaa 25%, #999999 50%, #777777 75%, #666666 100%)';
        elements.mainContent.style.background = 'linear-gradient(145deg, #f5f5f5 0%, #ffffff 50%, #f5f5f5 100%)';
      }

      function generateColorsFromPrompt(prompt) {
        const lowerPrompt = prompt.toLowerCase();
        
        // Enhanced keyword matching
        if (lowerPrompt.match(/spa|calm|zen|relaxing|peaceful|meditation/)) {
          return paletteTemplates.spa;
        } else if (lowerPrompt.match(/tech|startup|digital|electric|modern|innovation/)) {
          return paletteTemplates.tech;
        } else if (lowerPrompt.match(/autumn|cozy|warm|coffee|fall|rustic/)) {
          return paletteTemplates.autumn;
        } else if (lowerPrompt.match(/ocean|sea|depth|marine|aquatic|blue/)) {
          return paletteTemplates.ocean;
        } else if (lowerPrompt.match(/sunrise|sunset|dawn|golden|morning/)) {
          return paletteTemplates.sunrise;
        }
        
        return paletteTemplates.default;
      }

      // Enhanced Image Color Extraction with 14+ colors
      function extractColorsFromImage(img) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Optimize canvas size for performance while maintaining quality
        const maxSize = 500;
        const ratio = Math.min(maxSize / img.width, maxSize / img.height);
        canvas.width = Math.floor(img.width * ratio);
        canvas.height = Math.floor(img.height * ratio);
        
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const analysisResults = analyzeImageColors(imageData, img.width, img.height);
        
        // Store analysis data for display
        state.imageAnalysisData = analysisResults;
        
        return analysisResults.palette;
      }

      function analyzeImageColors(imageData, originalWidth, originalHeight) {
        const data = imageData.data;
        const pixels = [];
        const colorFrequency = new Map();
        let totalPixels = 0;
        let brightPixels = 0;
        let darkPixels = 0;
        let averageR = 0, averageG = 0, averageB = 0;
        
        // Sample every nth pixel for performance
        const sampleRate = Math.max(1, Math.floor(data.length / (4 * 12000))); // Max 12000 samples
        
        for (let i = 0; i < data.length; i += 4 * sampleRate) {
          const [r, g, b, a] = [data[i], data[i + 1], data[i + 2], data[i + 3]];
          
          if (a < 200) continue; // Skip transparent/semi-transparent pixels
          
          const brightness = (r + g + b) / 3;
          totalPixels++;
          
          if (brightness > 200) brightPixels++;
          if (brightness < 55) darkPixels++;
          
          averageR += r;
          averageG += g;
          averageB += b;
          
          // For significant colors only
          if (brightness >= 20 && brightness <= 245) {
            pixels.push({ r, g, b });
          }
          
          // Track color frequency
          const colorKey = `${Math.round(r/6)*6},${Math.round(g/6)*6},${Math.round(b/6)*6}`;
          colorFrequency.set(colorKey, (colorFrequency.get(colorKey) || 0) + 1);
        }
        
        // Calculate averages
        averageR = Math.round(averageR / totalPixels);
        averageG = Math.round(averageG / totalPixels);
        averageB = Math.round(averageB / totalPixels);
        
        // Use K-means clustering for better color extraction with 14 clusters
        const clusters = kmeansCluster(pixels, 14);
        
        // Create palette with detailed information
        const palette = clusters
          .sort((a, b) => b.count - a.count)
          .map((cluster, index) => {
            const roles = [
              'Primary', 'Secondary', 'Accent 1', 'Accent 2', 'Accent 3', 'Accent 4',
              'Neutral', 'Light 1', 'Light 2', 'Light 3', 'Dark 1', 'Dark 2',
              'Supporting', 'Supporting 2'
            ];
            const { r, g, b } = cluster.centroid;
            
            return {
              hex: rgbToHex(Math.round(r), Math.round(g), Math.round(b)),
              rgb: {r: Math.round(r), g: Math.round(g), b: Math.round(b)},
              hsl: rgbToHslObject(Math.round(r), Math.round(g), Math.round(b)),
              role: roles[index] || 'Extra',
              name: `Color ${index + 1}`,
              frequency: cluster.count,
              percentage: ((cluster.count / totalPixels) * 100).toFixed(1),
              luminance: getLuminance({ r: Math.round(r), g: Math.round(g), b: Math.round(b) })
            };
          });
        
        return {
          palette,
          stats: {
            totalPixels,
            brightPixels,
            darkPixels,
            brightPercentage: ((brightPixels / totalPixels) * 100).toFixed(1),
            darkPercentage: ((darkPixels / totalPixels) * 100).toFixed(1),
            averageColor: rgbToHex(averageR, averageG, averageB),
            dimensions: `${originalWidth}×${originalHeight}`,
            dominantColors: palette.length,
            colorVariety: colorFrequency.size,
            averageLuminance: (averageR * 0.299 + averageG * 0.587 + averageB * 0.114) / 255
          }
        };
      }

      function kmeansCluster(pixels, k) {
        if (pixels.length === 0) return [];
        
        // Initialize centroids with better distribution
        let centroids = [];
        for (let i = 0; i < k; i++) {
          const randomPixel = pixels[Math.floor(Math.random() * pixels.length)];
          centroids.push({ ...randomPixel });
        }
        
        let clusters;
        let iterations = 0;
        const maxIterations = 35;
        
        do {
          // Assign pixels to nearest centroid
          clusters = centroids.map(() => ({ pixels: [], count: 0 }));
          
          pixels.forEach(pixel => {
            let minDistance = Infinity;
            let closestCluster = 0;
            
            centroids.forEach((centroid, index) => {
              const distance = colorDistance(pixel, centroid);
              if (distance < minDistance) {
                minDistance = distance;
                closestCluster = index;
              }
            });
            
            clusters[closestCluster].pixels.push(pixel);
            clusters[closestCluster].count++;
          });
          
          // Update centroids
          const newCentroids = clusters.map(cluster => {
            if (cluster.pixels.length === 0) return centroids[0]; // Fallback
            
            const avgR = cluster.pixels.reduce((sum, p) => sum + p.r, 0) / cluster.pixels.length;
            const avgG = cluster.pixels.reduce((sum, p) => sum + p.g, 0) / cluster.pixels.length;
            const avgB = cluster.pixels.reduce((sum, p) => sum + p.b, 0) / cluster.pixels.length;
            
            return { r: avgR, g: avgG, b: avgB };
          });
          
          // Check convergence
          const converged = newCentroids.every((newCentroid, index) => {
            const oldCentroid = centroids[index];
            return colorDistance(newCentroid, oldCentroid) < 2;
          });
          
          centroids = newCentroids;
          iterations++;
          
          if (converged || iterations >= maxIterations) break;
          
        } while (true);
        
        // Return clusters with their centroids and counts
        return clusters
          .filter(cluster => cluster.count > 0)
          .map((cluster, index) => ({
            centroid: centroids[index],
            count: cluster.count
          }));
      }

      function colorDistance(color1, color2) {
        // Weighted Euclidean distance considering human perception
        const dr = color1.r - color2.r;
        const dg = color1.g - color2.g;
        const db = color1.b - color2.b;
        
        // Weight green more heavily as humans are more sensitive to green
        return Math.sqrt(2 * dr * dr + 4 * dg * dg + 3 * db * db);
      }

      // Enhanced Palette Display with RGB and HSL values
      function displayPalette(colors) {
        elements.colorPalette.innerHTML = '';
        
        // Show palette info and controls
        elements.paletteInfo.style.display = 'block';
        elements.paletteControls.style.display = 'flex';
        elements.paletteInfoText.textContent = `${colors.length} colors generated with RGB, HSL values and comprehensive WCAG analysis`;
        
        colors.forEach((color, index) => {
          const colorDiv = document.createElement('div');
          colorDiv.className = 'color-card';
          
          // Apply color blindness filter if active
          const displayColor = applyColorBlindnessFilter(color.hex);
          colorDiv.style.backgroundColor = displayColor;
          
          // Add interactive attributes
          colorDiv.setAttribute('role', 'button');
          colorDiv.setAttribute('tabindex', '0');
          colorDiv.setAttribute('aria-label', `${color.role} color ${displayColor}. Click to copy.`);
          
          // Enhanced tooltip with HEX, RGB and HSL values
          let tooltipText = `${color.name || color.role}: ${displayColor}\nRGB: ${color.rgb ? `rgb(${color.rgb.r}, ${color.rgb.g}, ${color.rgb.b})` : 'N/A'}\nHSL: ${color.hsl ? `hsl(${color.hsl.h}, ${color.hsl.s}%, ${color.hsl.l}%)` : 'N/A'}\nClick to copy to clipboard`;
          if (color.frequency) {
            tooltipText += `\nFrequency: ${color.frequency} pixels (${color.percentage}%)`;
          }
          if (color.luminance !== undefined) {
            tooltipText += `\nLuminance: ${color.luminance.toFixed(3)}`;
          }
          colorDiv.setAttribute('data-color-details', tooltipText);
          
          // Add color information overlay
          const colorInfo = document.createElement('div');
          colorInfo.className = 'color-info';
          let infoHTML = `
            <div class="color-role">${color.role}</div>
            <div>${displayColor}</div>
          `;
          if (color.percentage) {
            infoHTML += `<div style="font-size: 0.65rem; opacity: 0.8;">${color.percentage}%</div>`;
          } else {
            infoHTML += `<div style="font-size: 0.65rem; opacity: 0.8;">${color.name}</div>`;
          }
          colorInfo.innerHTML = infoHTML;
          colorDiv.appendChild(colorInfo);

          // Add event listeners
          colorDiv.addEventListener('click', () => copyColorToClipboard(displayColor, color));
          colorDiv.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              copyColorToClipboard(displayColor, color);
            }
          });
          
          // Staggered animation
          colorDiv.style.opacity = '0';
          colorDiv.style.transform = 'translateY(20px) scale(0.9)';
          
          elements.colorPalette.appendChild(colorDiv);
          
          // Trigger animation
          setTimeout(() => {
            colorDiv.style.transition = 'all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            colorDiv.style.opacity = '1';
            colorDiv.style.transform = 'translateY(0) scale(1)';
          }, index * 50);
        });
      }
      
      function applyColorBlindnessFilter(hex) {
        if (state.cbMode === 'normal') return hex;
        
        const rgb = hexToRgb(hex);
        if (!rgb) return hex;
        
        let simulatedRgb;
        switch (state.cbMode) {
          case 'deuteranopia':
            simulatedRgb = colorBlindness.simulateDeuteranopia(rgb);
            break;
          case 'protanopia':
            simulatedRgb = colorBlindness.simulateProtanopia(rgb);
            break;
          case 'tritanopia':
            simulatedRgb = colorBlindness.simulateTritanopia(rgb);
            break;
          case 'monochromacy':
            simulatedRgb = colorBlindness.simulateMonochromacy(rgb);
            break;
          default:
            return hex;
        }
        
        return rgbToHex(
          Math.round(Math.max(0, Math.min(255, simulatedRgb.r))),
          Math.round(Math.max(0, Math.min(255, simulatedRgb.g))),
          Math.round(Math.max(0, Math.min(255, simulatedRgb.b)))
        );
      }
      
      // Enhanced JSON Export with RGB and HSL values
      function exportPaletteAsJSON() {
        if (state.currentPalette.length === 0) {
          alert('No palette to export. Please generate a palette first.');
          return;
        }
        const paletteData = {
          metadata: {
            name: state.isImageUpload ? 'Image-Based Palette' : 'Text-Based Palette',
            generatedAt: new Date().toISOString(),
            colorCount: state.currentPalette.length,
            source: state.isImageUpload ? 'image' : 'text',
            prompt: state.isImageUpload ? null : elements.textPrompt.value.trim(),
            imageInfo: state.isImageUpload && state.imageAnalysisData ? {
              dimensions: state.imageAnalysisData.stats.dimensions,
              dominantColors: state.imageAnalysisData.stats.dominantColors,
              brightPercentage: state.imageAnalysisData.stats.brightPercentage,
              darkPercentage: state.imageAnalysisData.stats.darkPercentage,
              colorVariety: state.imageAnalysisData.stats.colorVariety
            } : null,
            wcagCompliance: state.wcagCompliance
          },
          colors: state.currentPalette.map((color, index) => ({
            id: index + 1,
            hex: color.hex,
            rgb: color.rgb || hexToRgbObject(color.hex),
            hsl: color.hsl || rgbToHslObject(...Object.values(color.rgb || hexToRgbObject(color.hex))),
            name: color.name,
            role: color.role,
            luminance: color.luminance || getLuminance(color.rgb || hexToRgbObject(color.hex)),
            frequency: color.frequency || null,
            percentage: color.percentage || null
          })),
          accessibility: {
            colorBlindnessSimulations: {
              deuteranopia: state.currentPalette.map(c => applyColorBlindnessFilter(c.hex)),
              protanopia: state.currentPalette.map(c => applyColorBlindnessFilter(c.hex)),
              tritanopia: state.currentPalette.map(c => applyColorBlindnessFilter(c.hex)),
              monochromacy: state.currentPalette.map(c => applyColorBlindnessFilter(c.hex))
            },
            contrastPairs: generateContrastPairsForExport(state.currentPalette)
          }
        };
        
        // Create and download JSON file
        const jsonString = JSON.stringify(paletteData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `chromagen-palette-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Show success notification
        showCopyNotification('🎉 Palette exported as JSON!');
      }
      
      function generateContrastPairsForExport(colors) {
        const lightColors = colors.filter(c => getLuminance(c.rgb || hexToRgbObject(c.hex)) > 0.5);
        const darkColors = colors.filter(c => getLuminance(c.rgb || hexToRgbObject(c.hex)) <= 0.5);
        
        const contrastPairs = [];
        lightColors.forEach(light => {
          darkColors.forEach(dark => {
            const lightRgb = light.rgb || hexToRgbObject(light.hex);
            const darkRgb = dark.rgb || hexToRgbObject(dark.hex);
            const contrast = getContrastRatio(lightRgb, darkRgb);
            const wcagLevel = getWCAGLevel(contrast);
            contrastPairs.push({
              lightColor: {
                hex: light.hex,
                rgb: lightRgb,
                hsl: light.hsl || rgbToHslObject(lightRgb.r, lightRgb.g, lightRgb.b),
                role: light.role,
                name: light.name
              },
              darkColor: {
                hex: dark.hex,
                rgb: darkRgb,
                hsl: dark.hsl || rgbToHslObject(darkRgb.r, darkRgb.g, darkRgb.b),
                role: dark.role,
                name: dark.name
              },
              contrastRatio: parseFloat(contrast.toFixed(2)),
              wcagLevel: wcagLevel.level,
              normalTextPass: wcagLevel.normalText,
              largeTextPass: wcagLevel.largeText,
              enhancedPass: wcagLevel.enhanced
            });
          });
        });
        
        return contrastPairs.sort((a, b) => b.contrastRatio - a.contrastRatio).slice(0, 10);
      }
      
      // Comprehensive WCAG Accessibility Analysis
      function showAccessibilityAnalysis(colors) {
        elements.accessibilitySection.hidden = false;
        
        // Show image analysis section if this is from an uploaded image
        if (state.isImageUpload && state.imageAnalysisData) {
          displayImageAnalysis(state.imageAnalysisData.stats);
        } else {
          elements.imageAnalysis.style.display = 'none';
        }
        
        // Calculate and display comprehensive WCAG compliance
        const wcagCompliance = calculateWCAGCompliance(colors);
        state.wcagCompliance = wcagCompliance;
        
        if (state.isImageUpload) {
          displayWCAGAnalysis(wcagCompliance);
        } else {
          elements.wcagAnalysis.style.display = 'none';
        }
        
        elements.contrastResults.innerHTML = '';
        
        // Enhanced contrast analysis
        const contrastPairs = generateContrastPairs(colors);
        
        // Display comprehensive contrast analysis
        displayContrastAnalysis(contrastPairs.slice(0, 12));
        
        // Update color blindness simulation mini-palettes
        updateColorBlindnessSimulations(colors);
      }
      
      function calculateWCAGCompliance(colors) {
        const lightColors = colors.filter(c => {
          const rgb = c.rgb || hexToRgbObject(c.hex);
          return getLuminance(rgb) > 0.5;
        });
        const darkColors = colors.filter(c => {
          const rgb = c.rgb || hexToRgbObject(c.hex);
          return getLuminance(rgb) <= 0.5;
        });
        
        let totalPairs = 0;
        let aaCompliantPairs = 0;
        let aaaCompliantPairs = 0;
        let failingPairs = 0;
        
        const allPairs = [];
        
        lightColors.forEach(light => {
          darkColors.forEach(dark => {
            const lightRgb = light.rgb || hexToRgbObject(light.hex);
            const darkRgb = dark.rgb || hexToRgbObject(dark.hex);
            const contrast = getContrastRatio(lightRgb, darkRgb);
            totalPairs++;
            
            if (contrast >= 7) {
              aaaCompliantPairs++;
              aaCompliantPairs++;
            } else if (contrast >= 4.5) {
              aaCompliantPairs++;
            } else {
              failingPairs++;
            }
            
            allPairs.push({
              light, dark, contrast,
              wcag: getWCAGLevel(contrast)
            });
          });
        });
        
        return {
          totalPairs,
          aaCompliantPairs,
          aaaCompliantPairs,
          failingPairs,
          aaPercentage: ((aaCompliantPairs / totalPairs) * 100).toFixed(1),
          aaaPercentage: ((aaaCompliantPairs / totalPairs) * 100).toFixed(1),
          failPercentage: ((failingPairs / totalPairs) * 100).toFixed(1),
          bestContrast: Math.max(...allPairs.map(p => p.contrast)),
          worstContrast: Math.min(...allPairs.map(p => p.contrast)),
          averageContrast: (allPairs.reduce((sum, p) => sum + p.contrast, 0) / totalPairs).toFixed(2),
          allPairs
        };
      }
      
      function displayWCAGAnalysis(compliance) {
        elements.wcagAnalysis.style.display = 'block';
        
        elements.wcagSummary.innerHTML = `
          <div class="wcag-stat">
            <span class="wcag-stat-value aaa-compliant">${compliance.aaaCompliantPairs}</span>
            <span class="wcag-stat-label">AAA Compliant</span>
          </div>
          <div class="wcag-stat">
            <span class="wcag-stat-value aa-compliant">${compliance.aaCompliantPairs}</span>
            <span class="wcag-stat-label">AA Compliant</span>
          </div>
          <div class="wcag-stat">
            <span class="wcag-stat-value fail-compliant">${compliance.failingPairs}</span>
            <span class="wcag-stat-label">Non-Compliant</span>
          </div>
          <div class="wcag-stat">
            <span class="wcag-stat-value">${compliance.totalPairs}</span>
            <span class="wcag-stat-label">Total Pairs</span>
          </div>
          <div class="wcag-stat">
            <span class="wcag-stat-value aaa-compliant">${compliance.bestContrast.toFixed(2)}:1</span>
            <span class="wcag-stat-label">Best Contrast</span>
          </div>
          <div class="wcag-stat">
            <span class="wcag-stat-value fail-compliant">${compliance.worstContrast.toFixed(2)}:1</span>
            <span class="wcag-stat-label">Worst Contrast</span>
          </div>
        `;
      }
      
      function generateContrastPairs(colors) {
        const lightColors = colors.filter(c => {
          const rgb = c.rgb || hexToRgbObject(c.hex);
          return getLuminance(rgb) > 0.5;
        });
        const darkColors = colors.filter(c => {
          const rgb = c.rgb || hexToRgbObject(c.hex);
          return getLuminance(rgb) <= 0.5;
        });
        
        const contrastPairs = [];
        lightColors.forEach(light => {
          darkColors.forEach(dark => {
            const lightRgb = light.rgb || hexToRgbObject(light.hex);
            const darkRgb = dark.rgb || hexToRgbObject(dark.hex);
            const contrast = getContrastRatio(lightRgb, darkRgb);
            const wcagLevel = getWCAGLevel(contrast);
            contrastPairs.push({
              light,
              dark,
              contrast,
              level: wcagLevel.level,
              details: wcagLevel
            });
          });
        });
        
        // Sort by contrast ratio (best first)
        return contrastPairs.sort((a, b) => b.contrast - a.contrast);
      }
      
      function displayImageAnalysis(stats) {
        elements.imageAnalysis.style.display = 'block';
        
        elements.imageStats.innerHTML = `
          <div class="stat-card">
            <span class="stat-value">${stats.dimensions}</span>
            <span class="stat-label">Image Dimensions</span>
          </div>
          <div class="stat-card">
            <span class="stat-value">${stats.dominantColors}</span>
            <span class="stat-label">Extracted Colors</span>
          </div>
          <div class="stat-card">
            <span class="stat-value">${stats.brightPercentage}%</span>
            <span class="stat-label">Bright Areas</span>
          </div>
          <div class="stat-card">
            <span class="stat-value">${stats.darkPercentage}%</span>
            <span class="stat-label">Dark Areas</span>
          </div>
          <div class="stat-card">
            <span class="stat-value">${stats.colorVariety}</span>
            <span class="stat-label">Color Variety</span>
          </div>
          <div class="stat-card" style="background: ${stats.averageColor};">
            <span class="stat-value" style="color: ${getLuminance(hexToRgbObject(stats.averageColor)) > 0.5 ? '#000' : '#fff'};">${stats.averageColor}</span>
            <span class="stat-label" style="color: ${getLuminance(hexToRgbObject(stats.averageColor)) > 0.5 ? '#666' : '#ccc'};">Average Color</span>
          </div>
        `;
      }
      
      function displayContrastAnalysis(pairs) {
        pairs.forEach((pair, index) => {
          const pairDiv = document.createElement('div');
          pairDiv.className = 'contrast-pair';
          pairDiv.style.opacity = '0';
          pairDiv.style.transform = 'translateY(20px)';
          
          const { contrast, level, details } = pair;
          const bgColor = applyColorBlindnessFilter(pair.dark.hex);
          const textColor = applyColorBlindnessFilter(pair.light.hex);
          
          // Calculate additional accessibility metrics
          const uiComponentRatio = contrast >= 3;
          const graphicalObjectRatio = contrast >= 3;
          const nonTextRatio = contrast >= 3;
          
          pairDiv.innerHTML = `
            <div class="contrast-demo" style="background: ${bgColor}; color: ${textColor};" title="Background: ${pair.dark.role}, Text: ${pair.light.role}">
              Aa
            </div>
            <div class="contrast-info">
              <div class="ratio-value">${contrast.toFixed(2)}:1</div>
              <div class="ratio-level level-${level.toLowerCase()}">${level} ${level === 'AAA' ? '⭐' : level === 'AA' ? '✓' : '⚠'}</div>
              <div class="color-roles">
                ${pair.dark.role} (bg) + ${pair.light.role} (text)
              </div>
              <div class="wcag-details">
                <div class="wcag-criterion ${details.normalText ? 'wcag-pass' : 'wcag-fail'}">
                  ${details.normalText ? '✅' : '❌'} Normal Text (4.5:1)
                </div>
                <div class="wcag-criterion ${details.largeText ? 'wcag-pass' : 'wcag-fail'}">
                  ${details.largeText ? '✅' : '❌'} Large Text (3:1)
                </div>
                <div class="wcag-criterion ${details.enhanced ? 'wcag-pass' : 'wcag-fail'}">
                  ${details.enhanced ? '✅' : '❌'} Enhanced (7:1)
                </div>
                <div class="wcag-criterion ${uiComponentRatio ? 'wcag-pass' : 'wcag-fail'}">
                  ${uiComponentRatio ? '✅' : '❌'} UI Components (3:1)
                </div>
                <div class="wcag-criterion ${graphicalObjectRatio ? 'wcag-pass' : 'wcag-fail'}">
                  ${graphicalObjectRatio ? '✅' : '❌'} Graphics (3:1)
                </div>
                <div class="wcag-criterion ${nonTextRatio ? 'wcag-pass' : 'wcag-fail'}">
                  ${nonTextRatio ? '✅' : '❌'} Non-Text (3:1)
                </div>
              </div>
            </div>
          `;
          
          elements.contrastResults.appendChild(pairDiv);
          
          // Animate in
          setTimeout(() => {
            pairDiv.style.transition = 'all 0.4s ease';
            pairDiv.style.opacity = '1';
            pairDiv.style.transform = 'translateY(0)';
          }, index * 60);
        });
      }
      
      function getWCAGLevel(ratio) {
        return {
          level: ratio >= 7 ? 'AAA' : ratio >= 4.5 ? 'AA' : 'Fail',
          normalText: ratio >= 4.5,
          largeText: ratio >= 3,
          enhanced: ratio >= 7,
          uiComponents: ratio >= 3,
          graphicalObjects: ratio >= 3,
          nonText: ratio >= 3
        };
      }
      
      function updateColorBlindnessSimulations(colors) {
        const simulations = {
          deuteranopia: colorBlindness.simulateDeuteranopia,
          protanopia: colorBlindness.simulateProtanopia,
          tritanopia: colorBlindness.simulateTritanopia,
          monochromacy: colorBlindness.simulateMonochromacy
        };
        
        Object.entries(simulations).forEach(([type, simulationFn]) => {
          const container = document.getElementById(`${type}-palette`);
          container.innerHTML = '';
          
          colors.slice(0, 6).forEach(color => {
            const rgb = color.rgb || hexToRgbObject(color.hex);
            const simulatedRgb = simulationFn(rgb);
            const simulatedHex = rgbToHex(
              Math.round(Math.max(0, Math.min(255, simulatedRgb.r))),
              Math.round(Math.max(0, Math.min(255, simulatedRgb.g))),
              Math.round(Math.max(0, Math.min(255, simulatedRgb.b)))
            );
            
            const miniColor = document.createElement('div');
            miniColor.className = 'mini-color';
            miniColor.style.backgroundColor = simulatedHex;
            miniColor.title = `${color.role}: ${simulatedHex}`;
            container.appendChild(miniColor);
          });
        });
      }
      
      // Enhanced Utility Functions with RGB and HSL support
      function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
          r: parseInt(result[1], 16),
          g: parseInt(result[2], 16),
          b: parseInt(result[3], 16)
        } : null;
      }

      function hexToRgbObject(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
          r: parseInt(result[1], 16),
          g: parseInt(result[2], 16),
          b: parseInt(result[3], 16)
        } : {r: 128, g: 128, b: 128};
      }
      
      function rgbToHex(r, g, b) {
        const toHex = (n) => {
          const hex = Math.round(Math.max(0, Math.min(255, n))).toString(16);
          return hex.length === 1 ? '0' + hex : hex;
        };
        return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
      }
      
      function rgbToHsl(r, g, b) {
        r /= 255;
        g /= 255;
        b /= 255;
        
        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        let h, s, l = (max + min) / 2;
        
        if (max === min) {
          h = s = 0; // achromatic
        } else {
          const d = max - min;
          s = l > 0.5 ? d / (2 - max - min) : d / (max + min);

          switch (max) {
            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
            case g: h = (b - r) / d + 2; break;
            case b: h = (r - g) / d + 4; break;
          }
          h /= 6;
        }
        
        return `hsl(${Math.round(h * 360)}, ${Math.round(s * 100)}%, ${Math.round(l * 100)}%)`;
      }

      function rgbToHslObject(r, g, b) {
        r /= 255;
        g /= 255;
        b /= 255;
        
        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        let h, s, l = (max + min) / 2;
        
        if (max === min) {
          h = s = 0; // achromatic
        } else {
          const d = max - min;
          s = l > 0.5 ? d / (2 - max - min) : d / (max + min);

          switch (max) {
            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
            case g: h = (b - r) / d + 2; break;
            case b: h = (r - g) / d + 4; break;
          }
          h /= 6;
        }
        
        return {
          h: Math.round(h * 360),
          s: Math.round(s * 100),
          l: Math.round(l * 100)
        };
      }
      
      function getLuminance({r, g, b}) {
        const [rs, gs, bs] = [r, g, b].map(c => {
          c /= 255;
          return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
        });
        return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;
      }
      
      function getContrastRatio(rgb1, rgb2) {
        const lum1 = getLuminance(rgb1);
        const lum2 = getLuminance(rgb2);
        const brightest = Math.max(lum1, lum2);
        const darkest = Math.min(lum1, lum2);
        return (brightest + 0.05) / (darkest + 0.05);
      }
      
      function copyColorToClipboard(colorCode, colorObj = null) {
        const copyText = colorCode.toUpperCase();
        
        // Try modern clipboard API first
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(copyText).then(() => {
            if (colorObj && colorObj.rgb && colorObj.hsl) {
              showCopyNotification(`🎨 ${copyText} copied!\nRGB: ${colorObj.rgb.r}, ${colorObj.rgb.g}, ${colorObj.rgb.b}\nHSL: ${colorObj.hsl.h}°, ${colorObj.hsl.s}%, ${colorObj.hsl.l}%`);
            } else {
              showCopyNotification(`🎨 ${copyText} copied!`);
            }
          }).catch(() => {
            fallbackCopyToClipboard(copyText);
          });
        } else {
          fallbackCopyToClipboard(copyText);
        }
      }
      
      function fallbackCopyToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
          document.execCommand('copy');
          showCopyNotification(`🎨 ${text} copied!`);
        } catch (err) {
          console.error('Failed to copy: ', err);
        } finally {
          document.body.removeChild(textArea);
        }
      }
      
      function showCopyNotification(message) {
        elements.copyNotification.textContent = message;
        elements.copyNotification.classList.add('show');
        
        setTimeout(() => {
          elements.copyNotification.classList.remove('show');
        }, 3000);
      }
      
      function showProcessingNotification() {
        elements.processingNotification.classList.add('show');
      }
      
      function hideProcessingNotification() {
        elements.processingNotification.classList.remove('show');
      }
      
      // Event Handlers
      function switchTab(tabName) {
        if (tabName === state.activeTab) return;
        
        // Update tab buttons
        const textTabBtn = document.getElementById('text-tab-btn');
        const imageTabBtn = document.getElementById('image-tab-btn');
        
        textTabBtn.classList.toggle('active', tabName === 'text');
        imageTabBtn.classList.toggle('active', tabName === 'image');
        
        textTabBtn.setAttribute('aria-selected', tabName === 'text');
        imageTabBtn.setAttribute('aria-selected', tabName === 'image');
        
        // Update tab panels
        elements.textTab.hidden = tabName !== 'text';
        elements.imageTab.hidden = tabName !== 'image';
        
        state.activeTab = tabName;
      }
      
      function handleImageUpload(file) {
        if (!file || !file.type.match(/^image\/(jpeg|jpg|png)$/)) {
          alert('Please select a valid image file (JPEG or PNG).');
          return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
          alert('File size must be less than 10MB.');
          return;
        }
        
        showProcessingNotification();
        
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            // Update UI to show image info
            elements.imageUpload.classList.add('has-image');
            elements.imageUpload.innerHTML = `
              <img src="${e.target.result}" alt="Uploaded image" class="image-preview">
              <div class="upload-status">
                <div class="checkmark">✓</div>
                <span>Image Ready for WCAG Analysis</span>
              </div>
              <small>Ready to extract 14+ colors with RGB, HSL values and full accessibility analysis</small>
            `;
            
            elements.imageInfo.style.display = 'block';
            elements.imageName.textContent = file.name;
            elements.imageDimensions.textContent = `${img.width} × ${img.height} pixels`;
            
            // Store image data for processing
            state.uploadedImageData = img;
            state.isImageUpload = true;
            
            hideProcessingNotification();
          };
          
          img.onerror = () => {
            hideProcessingNotification();
            alert('Failed to load image. Please try another file.');
          };
          
          img.src = e.target.result;
        };
        
        reader.onerror = () => {
          hideProcessingNotification();
          alert('Failed to read file. Please try again.');
        };
        
        reader.readAsDataURL(file);
      }
      
      function generatePalette() {
        if (state.isGenerating) return;
        
        if (state.activeTab === 'text' && !elements.textPrompt.value.trim()) {
          alert('Please enter a description for your palette.');
          elements.textPrompt.focus();
          return;
        }
        
        if (state.activeTab === 'image' && !state.uploadedImageData) {
          alert('Please upload an image first.');
          return;
        }
        
        state.isGenerating = true;
        elements.generateBtn.disabled = true;
        elements.loading.style.display = 'block';
        
        // Set image upload flag
        state.isImageUpload = state.activeTab === 'image';
        
        // Simulate processing time for text prompts, immediate for images
        const processingTime = state.activeTab === 'text' ? 2000 + Math.random() * 1000 : 100;
        
        setTimeout(() => {
          let colors;
          if (state.activeTab === 'text') {
            colors = generateColorsFromPrompt(elements.textPrompt.value.trim());
            state.isImageUpload = false;
          } else {
            colors = extractColorsFromImage(state.uploadedImageData);
            state.isImageUpload = true;
          }
          
          updatePalette(colors);
          
          state.isGenerating = false;
          elements.generateBtn.disabled = false;
          elements.loading.style.display = 'none';
        }, processingTime);
      }
      
      function updatePalette(colors) {
        state.currentPalette = colors;
        displayPalette(colors);
        showAccessibilityAnalysis(colors);
      }
      
      // Initialize Event Listeners
      function initializeEventListeners() {
        // Tab switching
        document.getElementById('text-tab-btn').addEventListener('click', () => switchTab('text'));
        document.getElementById('image-tab-btn').addEventListener('click', () => switchTab('image'));
        
        // JSON Export
        elements.saveJsonBtn.addEventListener('click', exportPaletteAsJSON);
        
        // Example prompts
        document.querySelectorAll('.example-tag').forEach((tag, index) => {
          const prompts = [
            'Create a calming spa palette with ocean blues, zen greens, and peaceful whites for ultimate relaxation',
            'Design an energetic tech startup palette with electric blues, modern grays, and vibrant accent colors',
            'Generate a cozy autumn café palette with warm oranges, rich browns, and comforting cream tones',
            'Build a mysterious ocean depth palette with deep blues, teal highlights, and pearl accents',
            'Craft a sunrise meditation palette with gentle oranges, soft yellows, and tranquil lavender hues'
          ];
          
          tag.addEventListener('click', () => {
            elements.textPrompt.value = prompts[index] || prompts[0];
            elements.textPrompt.focus();
          });
        });
        
        // Image upload
        elements.imageUpload.addEventListener('click', () => {
          if (!state.uploadedImageData) {
            elements.imageInput.click();
          }
        });
        
        elements.imageUpload.addEventListener('dragover', (e) => {
          e.preventDefault();
          elements.imageUpload.classList.add('dragover');
        });
        
        elements.imageUpload.addEventListener('dragleave', () => {
          elements.imageUpload.classList.remove('dragover');
        });
        
        elements.imageUpload.addEventListener('drop', (e) => {
          e.preventDefault();
          elements.imageUpload.classList.remove('dragover');
          
          if (e.dataTransfer.files.length > 0) {
            elements.imageInput.files = e.dataTransfer.files;
            handleImageUpload(e.dataTransfer.files[0]);
          }
        });
        
        elements.imageInput.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            handleImageUpload(e.target.files[0]);
          }
        });
        
        // Generate button
        elements.generateBtn.addEventListener('click', generatePalette);
        
        // Color blindness selector
        elements.cbSimSelect.addEventListener('change', (e) => {
          state.cbMode = e.target.value;
          updateFullUIForColorBlindness(state.cbMode);
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          if (e.ctrlKey || e.metaKey) {
            switch (e.key) {
              case 'Enter':
                e.preventDefault();
                generatePalette();
                break;
              case '1':
                e.preventDefault();
                switchTab('text');
                break;
              case '2':
                e.preventDefault();
                switchTab('image');
                break;
              case 's':
                e.preventDefault();
                if (state.currentPalette.length > 0) {
                  exportPaletteAsJSON();
                }
                break;
            }
          }
        });
      }
      
      // Initialize Application
      function initializeApp() {
        // Set initial state
        switchTab('text');
        updateFullUIForColorBlindness('normal');
        
        // Initialize all event listeners
        initializeEventListeners();
        
        console.log('🎨 ChromaGen Enhanced with RGB & HSL values initialized successfully!');
      }
      
      // Start the application
      initializeApp();
      
    })();
  </script>
</body>
</html>
