<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChromaGen - AI Color Palette Generator</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🎨</text></svg>" />
  <style>
    /* Reset & base */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #304ffe 0%, #bdbdbd 100%);
      color: #222;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 20px;
      transition: all 0.6s ease;
      position: relative;
      overflow-x: hidden;
    }

    /* Animated background particles */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255, 255, 255, 0.03) 0%, transparent 50%);
      animation: float 20s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(180deg); }
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      max-width: 1500px;
      width: 100%;
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.15);
      overflow: hidden;
      position: relative;
      z-index: 1;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Header with dynamic gradient */
    header {
      text-align: center;
      background: linear-gradient(135deg, #1976d2 0%, #ffb300 25%, #42a5f5 50%, #ab47bc 75%, #e91e63 100%);
      background-size: 400% 400%;
      animation: gradientShift 12s ease-in-out infinite;
      padding: 50px 40px;
      color: white;
      position: relative;
      overflow: hidden;
      transition: all 0.6s ease;
    }

    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: -50%;
      width: 200%;
      height: 100%;
      background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
      animation: shimmer 3s ease-in-out infinite;
    }

    header h1 {
      margin-bottom: 15px;
      font-weight: 800;
      font-size: 4rem;
      text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
      position: relative;
      z-index: 2;
      letter-spacing: 2px;
      background: linear-gradient(45deg, #ffffff, #f0f0f0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: textGlow 2s ease-in-out infinite alternate;
    }

    header p {
      font-size: 1.4rem;
      opacity: 0.95;
      font-weight: 500;
      position: relative;
      z-index: 2;
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.6;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      25% { background-position: 100% 50%; }
      50% { background-position: 100% 100%; }
      75% { background-position: 0% 100%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    @keyframes textGlow {
      0% { text-shadow: 3px 3px 6px rgba(0,0,0,0.3); }
      100% { text-shadow: 3px 3px 6px rgba(0,0,0,0.3), 0 0 20px rgba(255,255,255,0.5); }
    }

    .main-content {
      padding: 50px;
      background: linear-gradient(145deg, #f8f9fa 0%, #ffffff 50%, #f8f9fa 100%);
      transition: all 0.6s ease;
    }

    /* Input section and palette section */
    .flex-row {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
      margin-bottom: 40px;
    }

    .input-section, .palette-section {
      background: linear-gradient(145deg, #ffffff, #f8f9fa);
      border-radius: 20px;
      border: 2px solid #e9ecef;
      padding: 35px;
      flex: 1 1 450px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 30px rgba(0,0,0,0.05);
      transition: all 0.6s ease;
      position: relative;
      overflow: hidden;
    }

    .input-section::before, .palette-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #1976d2, #ffb300, #42a5f5, #ab47bc);
      transition: all 0.6s ease;
    }

    .section-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 25px;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Color blindness indicator */
    .cb-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 12px 20px;
      border-radius: 25px;
      font-weight: 600;
      z-index: 1000;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      transition: all 0.3s ease;
      display: none;
    }

    .cb-indicator.show {
      display: block;
      animation: slideIn 0.5s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Tabs */
    .tabs {
      display: flex;
      background: linear-gradient(145deg, #dee2e6, #e9ecef);
      border-radius: 15px;
      overflow: hidden;
      margin-bottom: 25px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.6s ease;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 15px 25px;
      cursor: pointer;
      font-weight: 600;
      color: #6c757d;
      background: none;
      border: none;
      transition: all 0.3s ease;
      user-select: none;
      position: relative;
      overflow: hidden;
    }

    .tab::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      transition: all 0.3s ease;
    }

    .tab:hover::before {
      left: 100%;
    }

    .tab.active {
      background: linear-gradient(145deg, #ffffff, #f0f7ff);
      color: #1a237e;
      box-shadow: 0 2px 8px rgba(33,150,243,0.2);
      transform: translateY(-2px);
    }

    /* Text input */
    #text-prompt {
      width: 100%;
      min-height: 120px;
      border-radius: 12px;
      border: 2px solid #dee2e6;
      padding: 20px;
      font-size: 1rem;
      font-family: inherit;
      resize: vertical;
      transition: all 0.3s ease;
      background: linear-gradient(145deg, #ffffff, #f8f9fa);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }

    #text-prompt:focus {
      outline: none;
      border-color: #1976d2;
      box-shadow: 0 0 0 4px rgba(25,118,210,0.15), inset 0 2px 4px rgba(0,0,0,0.05);
      transform: translateY(-2px);
    }

    /* Image upload */
    .image-upload {
      position: relative;
      border: 3px dashed #dee2e6;
      border-radius: 15px;
      height: 200px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #6c757d;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      user-select: none;
      flex-direction: column;
      gap: 12px;
      font-size: 1.1rem;
      background: linear-gradient(145deg, #f8f9fa, #ffffff);
    }

    .image-upload:hover {
      border-color: #1976d2;
      background: linear-gradient(145deg, #e3f2fd, #f0f7ff);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(25,118,210,0.15);
    }

    .image-upload.dragover {
      border-color: #1976d2;
      background: linear-gradient(145deg, #e3f2fd, #bbdefb);
      transform: scale(1.02);
    }

    .image-upload input[type="file"] {
      display: none;
    }

    .image-upload .icon {
      font-size: 4rem;
      animation: bounce 2s ease-in-out infinite;
    }

    .image-upload.has-image {
      border-color: #28a745;
      background: linear-gradient(145deg, #f8fff4, #e8f5e8);
    }

    .image-preview {
      max-width: 100%;
      max-height: 150px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 0px;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }

    /* Generate button */
    .generate-btn {
      margin-top: auto;
      padding: 20px;
      font-size: 1.2rem;
      font-weight: 700;
      border: none;
      border-radius: 15px;
      color: white;
      background: linear-gradient(135deg, #1976d2, #42a5f5, #0288d1);
      background-size: 200% 200%;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(25,118,210,0.3);
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
    }

    .generate-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: all 0.5s ease;
    }

    .generate-btn:hover:not(:disabled) {
      box-shadow: 0 12px 35px rgba(25,118,210,0.4);
      transform: translateY(-3px);
      background-position: right center;
    }

    .generate-btn:hover:not(:disabled)::before {
      left: 100%;
    }

    .generate-btn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      box-shadow: none;
      transform: none;
    }

    /* Color blindness selector */
    .cb-selector {
      background: linear-gradient(145deg, #e3f2fd, #f0f7ff);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 25px;
      border: 2px solid rgba(25,118,210,0.2);
      transition: all 0.6s ease;
    }

    .cb-selector label {
      display: block;
      font-weight: 600;
      margin-bottom: 10px;
      color: #1a237e;
    }

    #cb-sim {
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 2px solid #dee2e6;
      background: linear-gradient(145deg, #ffffff, #f8f9fa);
      color: #1a237e;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
    }

    #cb-sim:hover, #cb-sim:focus {
      border-color: #1976d2;
      box-shadow: 0 4px 12px rgba(25,118,210,0.15);
      outline: none;
    }

    /* Palette container */
    .palette-header {
      font-size: 1.6rem;
      font-weight: 700;
      padding-bottom: 15px;
      border-bottom: 3px solid;
      border-image: linear-gradient(90deg, #1976d2, #ffb300, #42a5f5) 1;
      color: #2c3e50;
      margin-bottom: 25px;
      transition: all 0.6s ease;
    }

    .color-palette {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .color-card {
      border-radius: 20px;
      cursor: pointer;
      overflow: hidden;
      position: relative;
      aspect-ratio: 1;
      border: 4px solid transparent;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      background-size: 200% 200%;
    }

    .color-card:hover {
      transform: scale(1.08) rotate(2deg);
      box-shadow: 0 15px 40px rgba(0,0,0,0.2);
      border-color: #1976d2;
      z-index: 10;
    }

    .color-info {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.9) 100%);
      color: white;
      padding: 12px 15px;
      font-size: 0.9rem;
      font-weight: 600;
      text-align: center;
      user-select: none;
      backdrop-filter: blur(5px);
    }

    .color-role {
      font-size: 0.75rem;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Example tags */
    .example-tag {
      display: inline-block;
      background: linear-gradient(145deg, #e9ecef, #f8f9fa);
      color: #495057;
      padding: 8px 15px;
      margin: 4px;
      border-radius: 20px;
      font-size: 0.85rem;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      font-family: inherit;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .example-tag:hover {
      background: linear-gradient(135deg, #1976d2, #42a5f5);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(25,118,210,0.3);
    }

    /* Accessibility section */
    .accessibility-section {
      border-radius: 20px;
      background: linear-gradient(145deg, #ffffff, #f8f9fa);
      box-shadow: 0 15px 35px rgba(0,0,0,0.08);
      padding: 35px;
      margin-top: 40px;
      border: 2px solid #e9ecef;
      transition: all 0.6s ease;
    }

    .accessibility-header {
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 15px;
      color: #2c3e50;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 3px solid;
      border-image: linear-gradient(90deg, #28a745, #ffc107, #dc3545) 1;
    }

    .accessibility-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 35px;
    }

    .contrast-checker, .colorblind-simulation {
      background: linear-gradient(145deg, #f8f9fa, #ffffff);
      padding: 25px;
      border-radius: 15px;
      border: 2px solid #e9ecef;
      box-shadow: 0 8px 20px rgba(0,0,0,0.05);
      transition: all 0.6s ease;
    }

    /* Enhanced Image Analysis Section */
    .image-analysis {
      grid-column: 1 / -1;
      background: linear-gradient(145deg, #e8f5e8, #f0fff0);
      border: 2px solid #28a745;
      margin-bottom: 25px;
      padding: 30px;
      border-radius: 15px;
    }

    .image-analysis h4 {
      color: #155724;
      margin-bottom: 25px;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .image-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(40, 167, 69, 0.3);
      text-align: center;
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.1);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.15);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #155724;
      display: block;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 5px;
    }

    /* Enhanced WCAG Analysis Section */
    .wcag-analysis {
      grid-column: 1 / -1;
      background: linear-gradient(145deg, #fff3cd, #fefdf6);
      border: 2px solid #ffc107;
      margin-bottom: 25px;
      padding: 30px;
      border-radius: 15px;
    }

    .wcag-analysis h4 {
      color: #856404;
      margin-bottom: 25px;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .wcag-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .wcag-stat {
      background: rgba(255, 255, 255, 0.8);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .wcag-stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      display: block;
    }

    .wcag-stat-label {
      font-size: 0.8rem;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .aaa-compliant { color: #28a745; }
    .aa-compliant { color: #ffc107; }
    .fail-compliant { color: #dc3545; }

    .contrast-pair {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 15px;
      background: linear-gradient(145deg, #ffffff, #f8f9fa);
      border-radius: 12px;
      margin-bottom: 15px;
      border: 2px solid #e9ecef;
      box-shadow: 0 4px 12px rgba(0,0,0,0.03);
      transition: all 0.3s ease;
    }

    .contrast-pair:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }

    .contrast-demo {
      width: 90px;
      height: 70px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 1.2rem;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
      flex-shrink: 0;
      border: 2px solid rgba(0,0,0,0.1);
    }

    .contrast-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .ratio-value {
      font-weight: 800;
      font-size: 1.3rem;
      color: #2c3e50;
    }

    .ratio-level {
      font-size: 0.8rem;
      font-weight: 700;
      border-radius: 20px;
      padding: 4px 12px;
      user-select: none;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: inline-block;
      width: fit-content;
    }

    .level-aaa {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      box-shadow: 0 2px 8px rgba(40,167,69,0.3);
    }

    .level-aa {
      background: linear-gradient(135deg, #ffc107, #ffca28);
      color: #212529;
      box-shadow: 0 2px 8px rgba(255,193,7,0.3);
    }

    .level-fail {
      background: linear-gradient(135deg, #dc3545, #e74c3c);
      color: white;
      box-shadow: 0 2px 8px rgba(220,53,69,0.3);
    }

    .color-roles {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 5px;
      font-weight: 500;
    }

    .wcag-details {
      font-size: 0.75rem;
      color: #6c757d;
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }

    .wcag-criterion {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 3px 8px;
      border-radius: 8px;
      font-weight: 600;
    }

    .wcag-pass {
      color: #28a745;
      background: rgba(40, 167, 69, 0.1);
    }

    .wcag-fail {
      color: #dc3545;
      background: rgba(220, 53, 69, 0.1);
    }

    .simulation-types {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
    }

    .simulation-type h4 {
      margin-bottom: 10px;
      font-size: 1rem;
      color: #2c3e50;
      font-weight: 600;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .mini-palette {
      display: flex;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      overflow: hidden;
      height: 40px;
      transition: all 0.3s ease;
    }

    .mini-palette:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .mini-color {
      flex: 1;
      transition: all 0.3s ease;
    }

    /* Copy notification */
    #copy-notification {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      padding: 15px 25px;
      border-radius: 15px;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      pointer-events: none;
      z-index: 1000;
      font-weight: 600;
      box-shadow: 0 8px 25px rgba(40,167,69,0.3);
      backdrop-filter: blur(10px);
    }

    #copy-notification.show {
      opacity: 1;
      transform: translateY(-10px) scale(1.05);
    }

    /* Processing notification */
    .processing-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 30px 40px;
      border-radius: 20px;
      z-index: 2000;
      text-align: center;
      backdrop-filter: blur(10px);
      display: none;
    }

    .processing-notification.show {
      display: block;
      animation: fadeInUp 0.5s ease;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translate(-50%, -50%) translateY(20px); }
      to { opacity: 1; transform: translate(-50%, -50%) translateY(0); }
    }

    /* Responsive design */
    @media (max-width: 1024px) {
      .flex-row {
        flex-direction: column;
      }
      .accessibility-grid {
        grid-template-columns: 1fr;
      }
      header h1 {
        font-size: 3rem;
      }
      .main-content {
        padding: 30px;
      }
      .container {
        max-width: 100%;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      header {
        padding: 30px 20px;
      }
      header h1 {
        font-size: 2.5rem;
      }
      .main-content {
        padding: 20px;
      }
      .input-section, .palette-section {
        padding: 25px;
      }
      .cb-indicator {
        position: relative;
        top: auto;
        right: auto;
        margin-bottom: 20px;
      }
      .image-stats {
        grid-template-columns: 1fr;
      }
      .contrast-demo {
        width: 70px;
        height: 50px;
        font-size: 1rem;
      }
      .wcag-details {
        grid-template-columns: 1fr;
      }
    }

    /* Loading animation */
    .loading {
      display: none;
      text-align: center;
      padding: 60px;
      color: #6c757d;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 6px solid #e9ecef;
      border-left: 6px solid #1976d2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 25px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 12px;
    }

    ::-webkit-scrollbar-track {
      background: linear-gradient(180deg, #f8f9fa, #e9ecef);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #1976d2, #42a5f5);
      border-radius: 10px;
      border: 2px solid #f8f9fa;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #0d47a1, #1976d2);
    }
  </style>
</head>
<body>
  <!-- Color Blindness Indicator -->
  <div class="cb-indicator" id="cb-indicator">
    Normal Vision
  </div>

  <!-- Processing Notification -->
  <div class="processing-notification" id="processing-notification">
    <div class="spinner" style="margin-bottom: 20px;"></div>
    <h3>🎨 Analyzing Your Image</h3>
    <p>Extracting colors and calculating comprehensive WCAG accessibility metrics...</p>
  </div>

  <div class="container">
    <header id="main-header">
      <h1>🎨 ChromaGen</h1>
      <p>AI-Powered Color Palette Generator with Comprehensive WCAG Accessibility Intelligence</p>
    </header>

    <main class="main-content" id="main-content">
      <div class="flex-row">
        <!-- Input Section -->
        <section class="input-section" aria-label="Palette generation inputs">
          <h2 class="section-title">
            <span>✨</span> Create Your Palette
          </h2>
          
          <nav class="tabs" role="tablist" aria-label="Input type selection" id="input-tabs">
            <button class="tab active" role="tab" aria-selected="true" id="text-tab-btn">
              📝 Text Prompt
            </button>
            <button class="tab" role="tab" aria-selected="false" id="image-tab-btn">
              🖼️ Image Upload
            </button>
          </nav>

          <div role="tabpanel" id="text-tab" aria-labelledby="text-tab-btn">
            <label for="text-prompt" style="font-weight: 600; margin-bottom: 12px; display: block; color: #2c3e50;">
              Describe your creative vision:
            </label>
            <textarea 
              id="text-prompt" 
              placeholder="Create an energetic palette for a fitness brand inspired by a tropical sunset with vibrant oranges and calming blues..."
              rows="5"
            ></textarea>
            <div style="margin-top: 15px; font-size: 0.95rem; color: #6c757d;">
              ✨ Try these inspiring examples: 
              <div style="margin-top: 10px;">
                <button type="button" class="example-tag">🧘 Calming Spa Retreat</button>
                <button type="button" class="example-tag">🚀 Tech Startup Energy</button>
                <button type="button" class="example-tag">🍂 Cozy Autumn Café</button>
                <button type="button" class="example-tag">🌊 Ocean Depth Mystery</button>
                <button type="button" class="example-tag">🌅 Sunrise Meditation</button>
              </div>
            </div>
          </div>

          <div role="tabpanel" id="image-tab" aria-labelledby="image-tab-btn" hidden>
            <label style="font-weight: 600; margin-bottom: 12px; display: block; color: #2c3e50;">
              Upload inspiration image:
            </label>
            <div class="image-upload" id="image-upload" tabindex="0" role="button">
              <div class="icon">📸</div>
              <p><strong>Click or drag & drop your image</strong></p>
              <small>JPG, PNG up to 10MB • Extract colors from photos, artwork, or designs</small>
              <input type="file" id="image-input" accept="image/jpeg,image/png,image/jpg" />
            </div>
            <div id="image-info" style="margin-top: 10px; font-size: 0.9rem; color: #6c757d; display: none;">
              <p><strong>✅ Image loaded:</strong> <span id="image-name"></span></p>
              <p><strong>📏 Dimensions:</strong> <span id="image-dimensions"></span></p>
            </div>
          </div>

          <div class="loading" id="loading">
            <div class="spinner"></div>
            <p><strong>🎨 Generating your perfect palette...</strong></p>
            <small>Analyzing colors and ensuring WCAG accessibility compliance</small>
          </div>

          <button class="generate-btn" id="generate-btn">
            🚀 Generate Palette
          </button>
        </section>

        <!-- Palette & Results Section -->
        <section class="palette-section">
          <div class="cb-selector">
            <label for="cb-sim">👁️ Color Blindness Simulation:</label>
            <select id="cb-sim" aria-label="Select color blindness simulation type">
              <option value="normal">👁️ Normal Vision</option>
              <option value="deuteranopia">🟢 Deuteranopia (Green-blind)</option>
              <option value="protanopia">🔴 Protanopia (Red-blind)</option>
              <option value="tritanopia">🔵 Tritanopia (Blue-blind)</option>
              <option value="monochromacy">⚫ Monochromacy (Grayscale)</option>
            </select>
          </div>

          <h2 class="palette-header">🎨 Your Generated Palette</h2>
          <div class="color-palette" id="color-palette">
            <!-- Dynamic color cards will be inserted here -->
          </div>
        </section>
      </div>

      <!-- Accessibility Analysis Section -->
      <section class="accessibility-section" id="accessibility-section" hidden>
        <h3 class="accessibility-header">
          <span>♿</span> Comprehensive WCAG Accessibility Analysis
        </h3>
        
        <!-- Image Analysis Section (shown only for uploaded images) -->
        <div class="image-analysis" id="image-analysis" style="display: none;">
          <h4>📊 Image Color Analysis</h4>
          <div class="image-stats" id="image-stats">
            <!-- Dynamic image statistics -->
          </div>
        </div>

        <!-- Enhanced WCAG Analysis Section for Images -->
        <div class="wcag-analysis" id="wcag-analysis" style="display: none;">
          <h4>📋 WCAG Compliance Summary</h4>
          <div class="wcag-summary" id="wcag-summary">
            <!-- Dynamic WCAG compliance statistics -->
          </div>
        </div>

        <div class="accessibility-grid">
          <div class="contrast-checker">
            <h4 style="margin-bottom: 20px; color: #2c3e50; font-size: 1.3rem;">
              📊 Detailed WCAG Contrast Analysis
            </h4>
            <div id="contrast-results">
              <!-- Dynamic contrast analysis results -->
            </div>
          </div>
          
          <div class="colorblind-simulation">
            <h4 style="margin-bottom: 20px; color: #2c3e50; font-size: 1.3rem;">
              👁️ Color Vision Simulations
            </h4>
            <div class="simulation-types">
              <div class="simulation-type">
                <h4>Deuteranopia</h4>
                <div class="mini-palette" id="deuteranopia-palette"></div>
              </div>
              <div class="simulation-type">
                <h4>Protanopia</h4>
                <div class="mini-palette" id="protanopia-palette"></div>
              </div>
              <div class="simulation-type">
                <h4>Tritanopia</h4>
                <div class="mini-palette" id="tritanopia-palette"></div>
              </div>
              <div class="simulation-type">
                <h4>Monochromacy</h4>
                <div class="mini-palette" id="monochromacy-palette"></div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Copy Notification -->
  <div id="copy-notification" role="alert">
    🎉 Color code copied to clipboard!
  </div>

  <script>
    // Main Application Controller
    (function() {
      'use strict';
      
      // DOM Elements
      const elements = {
        body: document.body,
        header: document.getElementById('main-header'),
        mainContent: document.getElementById('main-content'),
        inputTabs: document.getElementById('input-tabs'),
        textTab: document.getElementById('text-tab'),
        imageTab: document.getElementById('image-tab'),
        textPrompt: document.getElementById('text-prompt'),
        imageInput: document.getElementById('image-input'),
        imageUpload: document.getElementById('image-upload'),
        imageInfo: document.getElementById('image-info'),
        imageName: document.getElementById('image-name'),
        imageDimensions: document.getElementById('image-dimensions'),
        generateBtn: document.getElementById('generate-btn'),
        loading: document.getElementById('loading'),
        processingNotification: document.getElementById('processing-notification'),
        colorPalette: document.getElementById('color-palette'),
        contrastResults: document.getElementById('contrast-results'),
        accessibilitySection: document.getElementById('accessibility-section'),
        imageAnalysis: document.getElementById('image-analysis'),
        imageStats: document.getElementById('image-stats'),
        wcagAnalysis: document.getElementById('wcag-analysis'),
        wcagSummary: document.getElementById('wcag-summary'),
        cbSimSelect: document.getElementById('cb-sim'),
        cbIndicator: document.getElementById('cb-indicator'),
        copyNotification: document.getElementById('copy-notification')
      };

      // Application State
      let state = {
        activeTab: 'text',
        currentPalette: [],
        cbMode: 'normal',
        isGenerating: false,
        uploadedImageData: null,
        isImageUpload: false,
        imageAnalysisData: null,
        wcagCompliance: null
      };

      // Color Blindness Simulation Functions
      const colorBlindness = {
        simulateDeuteranopia: ({r, g, b}) => ({
          r: 0.625 * r + 0.375 * g,
          g: 0.7 * r + 0.3 * g,
          b: 0.3 * g + 0.7 * b
        }),
        
        simulateProtanopia: ({r, g, b}) => ({
          r: 0.567 * r + 0.433 * g,
          g: 0.558 * r + 0.442 * g,
          b: 0.242 * g + 0.758 * b
        }),
        
        simulateTritanopia: ({r, g, b}) => ({
          r: 0.95 * r + 0.05 * g,
          g: 0.433 * g + 0.567 * b,
          b: 0.475 * g + 0.525 * b
        }),
        
        simulateMonochromacy: ({r, g, b}) => {
          const gray = 0.299 * r + 0.587 * g + 0.114 * b;
          return {r: gray, g: gray, b: gray};
        }
      };

      // Background and UI Color Transformation
      function updateFullUIForColorBlindness(mode) {
        const modeNames = {
          normal: '👁️ Normal Vision',
          deuteranopia: '🟢 Deuteranopia (Green-blind)',
          protanopia: '🔴 Protanopia (Red-blind)',
          tritanopia: '🔵 Tritanopia (Blue-blind)',
          monochromacy: '⚫ Monochromacy (Grayscale)'
        };

        // Update indicator
        elements.cbIndicator.textContent = modeNames[mode] || modeNames.normal;
        elements.cbIndicator.classList.toggle('show', mode !== 'normal');

        // Apply transformations based on color blindness type
        switch(mode) {
          case 'normal':
            applyNormalTheme();
            break;
          case 'deuteranopia':
            applyDeuteranopiatheme();
            break;
          case 'protanopia':
            applyProtanopiaTheme();
            break;
          case 'tritanopia':
            applyTritanopiaTheme();
            break;
          case 'monochromacy':
            applyMonochromacyTheme();
            break;
        }

        // Update current palette display
        if (state.currentPalette.length > 0) {
          displayPalette(state.currentPalette);
        }
      }

      function applyNormalTheme() {
        elements.body.style.background = 'linear-gradient(135deg, #304ffe 0%, #bdbdbd 100%)';
        elements.header.style.background = 'linear-gradient(135deg, #1976d2 0%, #ffb300 25%, #42a5f5 50%, #ab47bc 75%, #e91e63 100%)';
        elements.mainContent.style.background = 'linear-gradient(145deg, #f8f9fa 0%, #ffffff 50%, #f8f9fa 100%)';
      }

      function applyDeuteranopiatheme() {
        elements.body.style.background = 'linear-gradient(135deg, #7b88d7 0%, #c7c7a3 100%)';
        elements.header.style.background = 'linear-gradient(135deg, #6b7bd6 0%, #e8c547 25%, #5a9bd4 50%, #9f5fb5 75%, #d4457a 100%)';
        elements.mainContent.style.background = 'linear-gradient(145deg, #f5f5f0 0%, #fefefe 50%, #f5f5f0 100%)';
      }

      function applyProtanopiaTheme() {
        elements.body.style.background = 'linear-gradient(135deg, #7887d8 0%, #d9cfb5 100%)';
        elements.header.style.background = 'linear-gradient(135deg, #4a6bd8 0%, #c7a547 25%, #4a9bd4 50%, #8f5fb5 75%, #7a457a 100%)';
        elements.mainContent.style.background = 'linear-gradient(145deg, #f2f5f0 0%, #fefefe 50%, #f2f5f0 100%)';
      }

      function applyTritanopiaTheme() {
        elements.body.style.background = 'linear-gradient(135deg, #a1a152 0%, #bdb9b8 100%)';
        elements.header.style.background = 'linear-gradient(135deg, #8f9152 0%, #d4a547 25%, #6fa152 50%, #9f5f85 75%, #d44575 100%)';
        elements.mainContent.style.background = 'linear-gradient(145deg, #f5f2f0 0%, #fefefe 50%, #f5f2f0 100%)';
      }

      function applyMonochromacyTheme() {
        elements.body.style.background = 'linear-gradient(135deg, #bbbbbb 0%, #eeeeee 100%)';
        elements.header.style.background = 'linear-gradient(135deg, #888888 0%, #aaaaaa 25%, #999999 50%, #777777 75%, #666666 100%)';
        elements.mainContent.style.background = 'linear-gradient(145deg, #f5f5f5 0%, #ffffff 50%, #f5f5f5 100%)';
      }

      // Enhanced Color Palette Generation
      const paletteTemplates = {
        spa: [
          {hex: '#0277bd', role: 'Primary'},
          {hex: '#26c6da', role: 'Secondary'},
          {hex: '#66bb6a', role: 'Accent 1'},
          {hex: '#ab47bc', role: 'Accent 2'},
          {hex: '#e0f2f1', role: 'Neutral'},
          {hex: '#f1f8e9', role: 'Light'},
          {hex: '#37474f', role: 'Dark'}
        ],
        
        tech: [
          {hex: '#1565c0', role: 'Primary'},
          {hex: '#ff6f00', role: 'Secondary'},
          {hex: '#00838f', role: 'Accent 1'},
          {hex: '#7b1fa2', role: 'Accent 2'},
          {hex: '#eceff1', role: 'Neutral'},
          {hex: '#f3e5f5', role: 'Light'},
          {hex: '#263238', role: 'Dark'}
        ],
        
        autumn: [
          {hex: '#d84315', role: 'Primary'},
          {hex: '#ff8f00', role: 'Secondary'},
          {hex: '#689f38', role: 'Accent 1'},
          {hex: '#512da8', role: 'Accent 2'},
          {hex: '#efebe9', role: 'Neutral'},
          {hex: '#fff3e0', role: 'Light'},
          {hex: '#3e2723', role: 'Dark'}
        ],
        
        ocean: [
          {hex: '#006064', role: 'Primary'},
          {hex: '#0288d1', role: 'Secondary'},
          {hex: '#26a69a', role: 'Accent 1'},
          {hex: '#5e35b1', role: 'Accent 2'},
          {hex: '#e0f7fa', role: 'Neutral'},
          {hex: '#f1f8e9', role: 'Light'},
          {hex: '#37474f', role: 'Dark'}
        ],
        
        sunrise: [
          {hex: '#e65100', role: 'Primary'},
          {hex: '#ffc107', role: 'Secondary'},
          {hex: '#8bc34a', role: 'Accent 1'},
          {hex: '#9c27b0', role: 'Accent 2'},
          {hex: '#fff3e0', role: 'Neutral'},
          {hex: '#f9fbe7', role: 'Light'},
          {hex: '#bf360c', role: 'Dark'}
        ],
        
        default: [
          {hex: '#1976d2', role: 'Primary'},
          {hex: '#ffb300', role: 'Secondary'},
          {hex: '#00acc1', role: 'Accent 1'},
          {hex: '#ab47bc', role: 'Accent 2'},
          {hex: '#f5f5f5', role: 'Neutral'},
          {hex: '#fafafa', role: 'Light'},
          {hex: '#212121', role: 'Dark'}
        ]
      };

      function generateColorsFromPrompt(prompt) {
        const lowerPrompt = prompt.toLowerCase();
        
        // Enhanced keyword matching
        if (lowerPrompt.match(/spa|calm|zen|relaxing|peaceful|meditation/)) {
          return paletteTemplates.spa;
        } else if (lowerPrompt.match(/tech|startup|digital|electric|modern|innovation/)) {
          return paletteTemplates.tech;
        } else if (lowerPrompt.match(/autumn|cozy|warm|coffee|fall|rustic/)) {
          return paletteTemplates.autumn;
        } else if (lowerPrompt.match(/ocean|sea|depth|marine|aquatic|blue/)) {
          return paletteTemplates.ocean;
        } else if (lowerPrompt.match(/sunrise|sunset|dawn|golden|morning/)) {
          return paletteTemplates.sunrise;
        }
        
        return paletteTemplates.default;
      }

      // Enhanced Image Color Extraction with comprehensive analysis
      function extractColorsFromImage(img) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Optimize canvas size for performance while maintaining quality
        const maxSize = 500;
        const ratio = Math.min(maxSize / img.width, maxSize / img.height);
        canvas.width = Math.floor(img.width * ratio);
        canvas.height = Math.floor(img.height * ratio);
        
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const analysisResults = analyzeImageColors(imageData, img.width, img.height);
        
        // Store analysis data for display
        state.imageAnalysisData = analysisResults;
        
        return analysisResults.palette;
      }

      function analyzeImageColors(imageData, originalWidth, originalHeight) {
        const data = imageData.data;
        const pixels = [];
        const colorFrequency = new Map();
        let totalPixels = 0;
        let brightPixels = 0;
        let darkPixels = 0;
        let averageR = 0, averageG = 0, averageB = 0;
        
        // Sample every nth pixel for performance
        const sampleRate = Math.max(1, Math.floor(data.length / (4 * 10000))); // Max 10000 samples
        
        for (let i = 0; i < data.length; i += 4 * sampleRate) {
          const [r, g, b, a] = [data[i], data[i + 1], data[i + 2], data[i + 3]];
          
          if (a < 200) continue; // Skip transparent/semi-transparent pixels
          
          const brightness = (r + g + b) / 3;
          totalPixels++;
          
          if (brightness > 200) brightPixels++;
          if (brightness < 55) darkPixels++;
          
          averageR += r;
          averageG += g;
          averageB += b;
          
          // For significant colors only
          if (brightness >= 20 && brightness <= 245) {
            pixels.push({ r, g, b });
          }
          
          // Track color frequency
          const colorKey = `${Math.round(r/8)*8},${Math.round(g/8)*8},${Math.round(b/8)*8}`;
          colorFrequency.set(colorKey, (colorFrequency.get(colorKey) || 0) + 1);
        }
        
        // Calculate averages
        averageR = Math.round(averageR / totalPixels);
        averageG = Math.round(averageG / totalPixels);
        averageB = Math.round(averageB / totalPixels);
        
        // Use K-means clustering for better color extraction
        const clusters = kmeansCluster(pixels, 8);
        
        // Create palette with detailed information
        const palette = clusters
          .sort((a, b) => b.count - a.count)
          .map((cluster, index) => {
            const roles = ['Primary', 'Secondary', 'Accent 1', 'Accent 2', 'Neutral', 'Light', 'Dark', 'Support'];
            const { r, g, b } = cluster.centroid;
            
            return {
              hex: rgbToHex(Math.round(r), Math.round(g), Math.round(b)),
              rgb: `rgb(${Math.round(r)}, ${Math.round(g)}, ${Math.round(b)})`,
              hsl: rgbToHsl(Math.round(r), Math.round(g), Math.round(b)),
              role: roles[index] || 'Extra',
              frequency: cluster.count,
              percentage: ((cluster.count / totalPixels) * 100).toFixed(1),
              luminance: getLuminance({ r: Math.round(r), g: Math.round(g), b: Math.round(b) })
            };
          });
        
        return {
          palette,
          stats: {
            totalPixels,
            brightPixels,
            darkPixels,
            brightPercentage: ((brightPixels / totalPixels) * 100).toFixed(1),
            darkPercentage: ((darkPixels / totalPixels) * 100).toFixed(1),
            averageColor: rgbToHex(averageR, averageG, averageB),
            dimensions: `${originalWidth}×${originalHeight}`,
            dominantColors: palette.length,
            colorVariety: colorFrequency.size,
            averageLuminance: (averageR * 0.299 + averageG * 0.587 + averageB * 0.114) / 255
          }
        };
      }

      function kmeansCluster(pixels, k) {
        if (pixels.length === 0) return [];
        
        // Initialize centroids with better distribution
        let centroids = [];
        for (let i = 0; i < k; i++) {
          const randomPixel = pixels[Math.floor(Math.random() * pixels.length)];
          centroids.push({ ...randomPixel });
        }
        
        let clusters;
        let iterations = 0;
        const maxIterations = 30;
        
        do {
          // Assign pixels to nearest centroid
          clusters = centroids.map(() => ({ pixels: [], count: 0 }));
          
          pixels.forEach(pixel => {
            let minDistance = Infinity;
            let closestCluster = 0;
            
            centroids.forEach((centroid, index) => {
              const distance = colorDistance(pixel, centroid);
              if (distance < minDistance) {
                minDistance = distance;
                closestCluster = index;
              }
            });
            
            clusters[closestCluster].pixels.push(pixel);
            clusters[closestCluster].count++;
          });
          
          // Update centroids
          const newCentroids = clusters.map(cluster => {
            if (cluster.pixels.length === 0) return centroids[0]; // Fallback
            
            const avgR = cluster.pixels.reduce((sum, p) => sum + p.r, 0) / cluster.pixels.length;
            const avgG = cluster.pixels.reduce((sum, p) => sum + p.g, 0) / cluster.pixels.length;
            const avgB = cluster.pixels.reduce((sum, p) => sum + p.b, 0) / cluster.pixels.length;
            
            return { r: avgR, g: avgG, b: avgB };
          });
          
          // Check convergence
          const converged = newCentroids.every((newCentroid, index) => {
            const oldCentroid = centroids[index];
            return colorDistance(newCentroid, oldCentroid) < 2;
          });
          
          centroids = newCentroids;
          iterations++;
          
          if (converged || iterations >= maxIterations) break;
          
        } while (true);
        
        // Return clusters with their centroids and counts
        return clusters
          .filter(cluster => cluster.count > 0)
          .map((cluster, index) => ({
            centroid: centroids[index],
            count: cluster.count
          }));
      }

      function colorDistance(color1, color2) {
        // Weighted Euclidean distance considering human perception
        const dr = color1.r - color2.r;
        const dg = color1.g - color2.g;
        const db = color1.b - color2.b;
        
        // Weight green more heavily as humans are more sensitive to green
        return Math.sqrt(2 * dr * dr + 4 * dg * dg + 3 * db * db);
      }

      // Enhanced Palette Display
      function displayPalette(colors) {
        elements.colorPalette.innerHTML = '';
        
        colors.forEach((color, index) => {
          const colorDiv = document.createElement('div');
          colorDiv.className = 'color-card';
          
          // Apply color blindness filter if active
          const displayColor = applyColorBlindnessFilter(color.hex);
          colorDiv.style.backgroundColor = displayColor;
          
          // Add interactive attributes
          colorDiv.setAttribute('role', 'button');
          colorDiv.setAttribute('tabindex', '0');
          colorDiv.setAttribute('aria-label', `${color.role} color ${displayColor}. Click to copy.`);
          
          let tooltipText = `${color.role}: ${displayColor}\nClick to copy to clipboard`;
          if (color.frequency) {
            tooltipText += `\nFrequency: ${color.frequency} pixels (${color.percentage}%)`;
          }
          if (color.luminance !== undefined) {
            tooltipText += `\nLuminance: ${color.luminance.toFixed(3)}`;
          }
          colorDiv.title = tooltipText;
          
          // Add color information overlay
          const colorInfo = document.createElement('div');
          colorInfo.className = 'color-info';
          let infoHTML = `
            <div class="color-role">${color.role}</div>
            <div>${displayColor}</div>
          `;
          if (color.percentage) {
            infoHTML += `<div style="font-size: 0.7rem; opacity: 0.8;">${color.percentage}%</div>`;
          }
          colorInfo.innerHTML = infoHTML;
          colorDiv.appendChild(colorInfo);
          
          // Add event listeners
          colorDiv.addEventListener('click', () => copyColorToClipboard(displayColor));
          colorDiv.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              copyColorToClipboard(displayColor);
            }
          });
          
          // Staggered animation
          colorDiv.style.opacity = '0';
          colorDiv.style.transform = 'translateY(20px) scale(0.9)';
          
          elements.colorPalette.appendChild(colorDiv);
          
          // Trigger animation
          setTimeout(() => {
            colorDiv.style.transition = 'all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            colorDiv.style.opacity = '1';
            colorDiv.style.transform = 'translateY(0) scale(1)';
          }, index * 80);
        });
      }

      function applyColorBlindnessFilter(hex) {
        if (state.cbMode === 'normal') return hex;
        
        const rgb = hexToRgb(hex);
        if (!rgb) return hex;
        
        let simulatedRgb;
        switch (state.cbMode) {
          case 'deuteranopia':
            simulatedRgb = colorBlindness.simulateDeuteranopia(rgb);
            break;
          case 'protanopia':
            simulatedRgb = colorBlindness.simulateProtanopia(rgb);
            break;
          case 'tritanopia':
            simulatedRgb = colorBlindness.simulateTritanopia(rgb);
            break;
          case 'monochromacy':
            simulatedRgb = colorBlindness.simulateMonochromacy(rgb);
            break;
          default:
            return hex;
        }
        
        return rgbToHex(
          Math.round(Math.max(0, Math.min(255, simulatedRgb.r))),
          Math.round(Math.max(0, Math.min(255, simulatedRgb.g))),
          Math.round(Math.max(0, Math.min(255, simulatedRgb.b)))
        );
      }

      // Comprehensive WCAG Accessibility Analysis
      function showAccessibilityAnalysis(colors) {
        elements.accessibilitySection.hidden = false;
        
        // Show image analysis section if this is from an uploaded image
        if (state.isImageUpload && state.imageAnalysisData) {
          displayImageAnalysis(state.imageAnalysisData.stats);
        } else {
          elements.imageAnalysis.style.display = 'none';
        }
        
        // Calculate and display comprehensive WCAG compliance
        const wcagCompliance = calculateWCAGCompliance(colors);
        state.wcagCompliance = wcagCompliance;
        
        if (state.isImageUpload) {
          displayWCAGAnalysis(wcagCompliance);
        } else {
          elements.wcagAnalysis.style.display = 'none';
        }
        
        elements.contrastResults.innerHTML = '';
        
        // Enhanced contrast analysis
        const contrastPairs = generateContrastPairs(colors);
        
        // Display comprehensive contrast analysis
        displayContrastAnalysis(contrastPairs.slice(0, 12));
        
        // Update color blindness simulation mini-palettes
        updateColorBlindnessSimulations(colors);
      }

      function calculateWCAGCompliance(colors) {
        const lightColors = colors.filter(c => getLuminance(hexToRgb(c.hex)) > 0.5);
        const darkColors = colors.filter(c => getLuminance(hexToRgb(c.hex)) <= 0.5);
        
        let totalPairs = 0;
        let aaCompliantPairs = 0;
        let aaaCompliantPairs = 0;
        let failingPairs = 0;
        
        const allPairs = [];
        
        lightColors.forEach(light => {
          darkColors.forEach(dark => {
            const contrast = getContrastRatio(hexToRgb(light.hex), hexToRgb(dark.hex));
            totalPairs++;
            
            if (contrast >= 7) {
              aaaCompliantPairs++;
              aaCompliantPairs++;
            } else if (contrast >= 4.5) {
              aaCompliantPairs++;
            } else {
              failingPairs++;
            }
            
            allPairs.push({
              light, dark, contrast,
              wcag: getWCAGLevel(contrast)
            });
          });
        });
        
        return {
          totalPairs,
          aaCompliantPairs,
          aaaCompliantPairs,
          failingPairs,
          aaPercentage: ((aaCompliantPairs / totalPairs) * 100).toFixed(1),
          aaaPercentage: ((aaaCompliantPairs / totalPairs) * 100).toFixed(1),
          failPercentage: ((failingPairs / totalPairs) * 100).toFixed(1),
          bestContrast: Math.max(...allPairs.map(p => p.contrast)),
          worstContrast: Math.min(...allPairs.map(p => p.contrast)),
          averageContrast: (allPairs.reduce((sum, p) => sum + p.contrast, 0) / totalPairs).toFixed(2),
          allPairs
        };
      }

      function displayWCAGAnalysis(compliance) {
        elements.wcagAnalysis.style.display = 'block';
        
        elements.wcagSummary.innerHTML = `
          <div class="wcag-stat">
            <span class="wcag-stat-value aaa-compliant">${compliance.aaaCompliantPairs}</span>
            <span class="wcag-stat-label">AAA Compliant</span>
          </div>
          <div class="wcag-stat">
            <span class="wcag-stat-value aa-compliant">${compliance.aaCompliantPairs}</span>
            <span class="wcag-stat-label">AA Compliant</span>
          </div>
          <div class="wcag-stat">
            <span class="wcag-stat-value fail-compliant">${compliance.failingPairs}</span>
            <span class="wcag-stat-label">Non-Compliant</span>
          </div>
          <div class="wcag-stat">
            <span class="wcag-stat-value">${compliance.totalPairs}</span>
            <span class="wcag-stat-label">Total Pairs</span>
          </div>
          <div class="wcag-stat">
            <span class="wcag-stat-value aaa-compliant">${compliance.bestContrast.toFixed(2)}:1</span>
            <span class="wcag-stat-label">Best Contrast</span>
          </div>
          <div class="wcag-stat">
            <span class="wcag-stat-value fail-compliant">${compliance.worstContrast.toFixed(2)}:1</span>
            <span class="wcag-stat-label">Worst Contrast</span>
          </div>
        `;
      }

      function generateContrastPairs(colors) {
        const lightColors = colors.filter(c => getLuminance(hexToRgb(c.hex)) > 0.5);
        const darkColors = colors.filter(c => getLuminance(hexToRgb(c.hex)) <= 0.5);
        
        const contrastPairs = [];
        lightColors.forEach(light => {
          darkColors.forEach(dark => {
            const contrast = getContrastRatio(hexToRgb(light.hex), hexToRgb(dark.hex));
            const wcagLevel = getWCAGLevel(contrast);
            contrastPairs.push({
              light,
              dark,
              contrast,
              level: wcagLevel.level,
              details: wcagLevel
            });
          });
        });
        
        // Sort by contrast ratio (best first)
        return contrastPairs.sort((a, b) => b.contrast - a.contrast);
      }

      function displayImageAnalysis(stats) {
        elements.imageAnalysis.style.display = 'block';
        
        elements.imageStats.innerHTML = `
          <div class="stat-card">
            <span class="stat-value">${stats.dimensions}</span>
            <span class="stat-label">Image Dimensions</span>
          </div>
          <div class="stat-card">
            <span class="stat-value">${stats.dominantColors}</span>
            <span class="stat-label">Extracted Colors</span>
          </div>
          <div class="stat-card">
            <span class="stat-value">${stats.brightPercentage}%</span>
            <span class="stat-label">Bright Areas</span>
          </div>
          <div class="stat-card">
            <span class="stat-value">${stats.darkPercentage}%</span>
            <span class="stat-label">Dark Areas</span>
          </div>
          <div class="stat-card">
            <span class="stat-value">${stats.colorVariety}</span>
            <span class="stat-label">Color Variety</span>
          </div>
          <div class="stat-card" style="background: ${stats.averageColor};">
            <span class="stat-value" style="color: ${getLuminance(hexToRgb(stats.averageColor)) > 0.5 ? '#000' : '#fff'};">${stats.averageColor}</span>
            <span class="stat-label" style="color: ${getLuminance(hexToRgb(stats.averageColor)) > 0.5 ? '#666' : '#ccc'};">Average Color</span>
          </div>
        `;
      }

      function displayContrastAnalysis(pairs) {
        pairs.forEach((pair, index) => {
          const pairDiv = document.createElement('div');
          pairDiv.className = 'contrast-pair';
          pairDiv.style.opacity = '0';
          pairDiv.style.transform = 'translateY(20px)';
          
          const { contrast, level, details } = pair;
          const bgColor = applyColorBlindnessFilter(pair.dark.hex);
          const textColor = applyColorBlindnessFilter(pair.light.hex);
          
          // Calculate additional accessibility metrics
          const uiComponentRatio = contrast >= 3;
          const graphicalObjectRatio = contrast >= 3;
          const nonTextRatio = contrast >= 3;
          
          pairDiv.innerHTML = `
            <div class="contrast-demo" style="background: ${bgColor}; color: ${textColor};" title="Background: ${pair.dark.role}, Text: ${pair.light.role}">
              Aa
            </div>
            <div class="contrast-info">
              <div class="ratio-value">${contrast.toFixed(2)}:1</div>
              <div class="ratio-level level-${level.toLowerCase()}">${level} ${level === 'AAA' ? '⭐' : level === 'AA' ? '✓' : '⚠️'}</div>
              <div class="color-roles">
                ${pair.dark.role} (bg) + ${pair.light.role} (text)
              </div>
              <div class="wcag-details">
                <div class="wcag-criterion ${details.normalText ? 'wcag-pass' : 'wcag-fail'}">
                  ${details.normalText ? '✅' : '❌'} Normal Text (4.5:1)
                </div>
                <div class="wcag-criterion ${details.largeText ? 'wcag-pass' : 'wcag-fail'}">
                  ${details.largeText ? '✅' : '❌'} Large Text (3:1)
                </div>
                <div class="wcag-criterion ${details.enhanced ? 'wcag-pass' : 'wcag-fail'}">
                  ${details.enhanced ? '✅' : '❌'} Enhanced (7:1)
                </div>
                <div class="wcag-criterion ${uiComponentRatio ? 'wcag-pass' : 'wcag-fail'}">
                  ${uiComponentRatio ? '✅' : '❌'} UI Components (3:1)
                </div>
                <div class="wcag-criterion ${graphicalObjectRatio ? 'wcag-pass' : 'wcag-fail'}">
                  ${graphicalObjectRatio ? '✅' : '❌'} Graphics (3:1)
                </div>
                <div class="wcag-criterion ${nonTextRatio ? 'wcag-pass' : 'wcag-fail'}">
                  ${nonTextRatio ? '✅' : '❌'} Non-Text (3:1)
                </div>
              </div>
            </div>
          `;
          
          elements.contrastResults.appendChild(pairDiv);
          
          // Animate in
          setTimeout(() => {
            pairDiv.style.transition = 'all 0.4s ease';
            pairDiv.style.opacity = '1';
            pairDiv.style.transform = 'translateY(0)';
          }, index * 60);
        });
      }

      function getWCAGLevel(ratio) {
        return {
          level: ratio >= 7 ? 'AAA' : ratio >= 4.5 ? 'AA' : 'Fail',
          normalText: ratio >= 4.5,
          largeText: ratio >= 3,
          enhanced: ratio >= 7,
          uiComponents: ratio >= 3,
          graphicalObjects: ratio >= 3,
          nonText: ratio >= 3
        };
      }

      function updateColorBlindnessSimulations(colors) {
        const simulations = {
          deuteranopia: colorBlindness.simulateDeuteranopia,
          protanopia: colorBlindness.simulateProtanopia,
          tritanopia: colorBlindness.simulateTritanopia,
          monochromacy: colorBlindness.simulateMonochromacy
        };
        
        Object.entries(simulations).forEach(([type, simulationFn]) => {
          const container = document.getElementById(`${type}-palette`);
          container.innerHTML = '';
          
          colors.forEach(color => {
            const rgb = hexToRgb(color.hex);
            const simulatedRgb = simulationFn(rgb);
            const simulatedHex = rgbToHex(
              Math.round(Math.max(0, Math.min(255, simulatedRgb.r))),
              Math.round(Math.max(0, Math.min(255, simulatedRgb.g))),
              Math.round(Math.max(0, Math.min(255, simulatedRgb.b)))
            );
            
            const miniColor = document.createElement('div');
            miniColor.className = 'mini-color';
            miniColor.style.backgroundColor = simulatedHex;
            miniColor.title = `${color.role}: ${simulatedHex}`;
            container.appendChild(miniColor);
          });
        });
      }

      // Utility Functions
      function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
          r: parseInt(result[1], 16),
          g: parseInt(result[2], 16),
          b: parseInt(result[3], 16)
        } : null;
      }

      function rgbToHex(r, g, b) {
        const toHex = (n) => {
          const hex = Math.round(Math.max(0, Math.min(255, n))).toString(16);
          return hex.length === 1 ? '0' + hex : hex;
        };
        return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
      }

      function rgbToHsl(r, g, b) {
        r /= 255;
        g /= 255;
        b /= 255;
        
        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        let h, s, l = (max + min) / 2;
        
        if (max === min) {
          h = s = 0; // achromatic
        } else {
          const d = max - min;
          s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
          
          switch (max) {
            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
            case g: h = (b - r) / d + 2; break;
            case b: h = (r - g) / d + 4; break;
          }
          h /= 6;
        }
        
        return `hsl(${Math.round(h * 360)}, ${Math.round(s * 100)}%, ${Math.round(l * 100)}%)`;
      }

      function getLuminance({r, g, b}) {
        const [rs, gs, bs] = [r, g, b].map(c => {
          c /= 255;
          return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
        });
        return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;
      }

      function getContrastRatio(rgb1, rgb2) {
        const lum1 = getLuminance(rgb1);
        const lum2 = getLuminance(rgb2);
        const brightest = Math.max(lum1, lum2);
        const darkest = Math.min(lum1, lum2);
        return (brightest + 0.05) / (darkest + 0.05);
      }

      function copyColorToClipboard(colorCode) {
        const copyText = colorCode.toUpperCase();
        
        // Try modern clipboard API first
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(copyText).then(() => {
            showCopyNotification(copyText);
          }).catch(() => {
            fallbackCopyToClipboard(copyText);
          });
        } else {
          fallbackCopyToClipboard(copyText);
        }
      }

      function fallbackCopyToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
          document.execCommand('copy');
          showCopyNotification(text);
        } catch (err) {
          console.error('Failed to copy: ', err);
        } finally {
          document.body.removeChild(textArea);
        }
      }

      function showCopyNotification(colorCode) {
        elements.copyNotification.textContent = `🎉 ${colorCode} copied to clipboard!`;
        elements.copyNotification.classList.add('show');
        
        setTimeout(() => {
          elements.copyNotification.classList.remove('show');
        }, 3000);
      }

      function showProcessingNotification() {
        elements.processingNotification.classList.add('show');
      }

      function hideProcessingNotification() {
        elements.processingNotification.classList.remove('show');
      }

      // Event Handlers
      function switchTab(tabName) {
        if (tabName === state.activeTab) return;
        
        // Update tab buttons
        const textTabBtn = document.getElementById('text-tab-btn');
        const imageTabBtn = document.getElementById('image-tab-btn');
        
        textTabBtn.classList.toggle('active', tabName === 'text');
        imageTabBtn.classList.toggle('active', tabName === 'image');
        
        textTabBtn.setAttribute('aria-selected', tabName === 'text');
        imageTabBtn.setAttribute('aria-selected', tabName === 'image');
        
        // Update tab panels
        elements.textTab.hidden = tabName !== 'text';
        elements.imageTab.hidden = tabName !== 'image';
        
        state.activeTab = tabName;
      }

      function handleImageUpload(file) {
        if (!file || !file.type.match(/^image\/(jpeg|jpg|png)$/)) {
          alert('Please select a valid image file (JPEG or PNG).');
          return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
          alert('File size must be less than 10MB.');
          return;
        }
        
        showProcessingNotification();
        
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            // Update UI to show image info
            elements.imageUpload.classList.add('has-image');
            elements.imageUpload.innerHTML = `
              <img src="${e.target.result}" alt="Uploaded image" class="image-preview">
              <p><strong>✅ Image Ready for WCAG Analysis</strong></p> <br>
            `;
            
            elements.imageInfo.style.display = 'block';
            elements.imageName.textContent = file.name;
            elements.imageDimensions.textContent = `${img.width} × ${img.height} pixels`;
            
            // Store image data for processing
            state.uploadedImageData = img;
            state.isImageUpload = true;
            
            hideProcessingNotification();
            
            // Auto-generate palette after a short delay
            setTimeout(() => {
              const colors = extractColorsFromImage(img);
              updatePalette(colors);
            }, 500);
          };
          
          img.onerror = () => {
            hideProcessingNotification();
            alert('Failed to load image. Please try another file.');
          };
          
          img.src = e.target.result;
        };
        
        reader.onerror = () => {
          hideProcessingNotification();
          alert('Failed to read file. Please try again.');
        };
        
        reader.readAsDataURL(file);
      }

      function generatePalette() {
        if (state.isGenerating) return;
        
        if (state.activeTab === 'text' && !elements.textPrompt.value.trim()) {
          alert('Please enter a description for your palette.');
          elements.textPrompt.focus();
          return;
        }
        
        if (state.activeTab === 'image' && !state.uploadedImageData) {
          alert('Please upload an image first.');
          return;
        }
        
        state.isGenerating = true;
        elements.generateBtn.disabled = true;
        elements.loading.style.display = 'block';
        
        // Set image upload flag
        state.isImageUpload = state.activeTab === 'image';
        
        // Simulate processing time for text prompts, immediate for images
        const processingTime = state.activeTab === 'text' ? 2000 + Math.random() * 1000 : 100;
        
        setTimeout(() => {
          let colors;
          if (state.activeTab === 'text') {
            colors = generateColorsFromPrompt(elements.textPrompt.value.trim());
            state.isImageUpload = false;
          } else {
            colors = extractColorsFromImage(state.uploadedImageData);
            state.isImageUpload = true;
          }
          
          updatePalette(colors);
          
          state.isGenerating = false;
          elements.generateBtn.disabled = false;
          elements.loading.style.display = 'none';
        }, processingTime);
      }

      function updatePalette(colors) {
        state.currentPalette = colors;
        displayPalette(colors);
        showAccessibilityAnalysis(colors);
      }

      // Initialize Event Listeners
      function initializeEventListeners() {
        // Tab switching
        document.getElementById('text-tab-btn').addEventListener('click', () => switchTab('text'));
        document.getElementById('image-tab-btn').addEventListener('click', () => switchTab('image'));
        
        // Example prompts
        document.querySelectorAll('.example-tag').forEach((tag, index) => {
          const prompts = [
            'Create a calming spa palette with ocean blues, zen greens, and peaceful whites for ultimate relaxation',
            'Design an energetic tech startup palette with electric blues, modern grays, and vibrant accent colors',
            'Generate a cozy autumn café palette with warm oranges, rich browns, and comforting cream tones',
            'Build a mysterious ocean depth palette with deep blues, teal highlights, and pearl accents',
            'Craft a sunrise meditation palette with gentle oranges, soft yellows, and tranquil lavender hues'
          ];
          
          tag.addEventListener('click', () => {
            elements.textPrompt.value = prompts[index] || prompts[0];
            elements.textPrompt.focus();
          });
        });
        
        // Image upload
        elements.imageUpload.addEventListener('click', () => {
          if (!state.uploadedImageData) {
            elements.imageInput.click();
          }
        });
        
        elements.imageUpload.addEventListener('dragover', (e) => {
          e.preventDefault();
          elements.imageUpload.classList.add('dragover');
        });
        
        elements.imageUpload.addEventListener('dragleave', () => {
          elements.imageUpload.classList.remove('dragover');
        });
        
        elements.imageUpload.addEventListener('drop', (e) => {
          e.preventDefault();
          elements.imageUpload.classList.remove('dragover');
          
          if (e.dataTransfer.files.length > 0) {
            elements.imageInput.files = e.dataTransfer.files;
            handleImageUpload(e.dataTransfer.files[0]);
          }
        });
        
        elements.imageInput.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            handleImageUpload(e.target.files[0]);
          }
        });
        
        // Generate button
        elements.generateBtn.addEventListener('click', generatePalette);
        
        // Color blindness selector
        elements.cbSimSelect.addEventListener('change', (e) => {
          state.cbMode = e.target.value;
          updateFullUIForColorBlindness(state.cbMode);
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          if (e.ctrlKey || e.metaKey) {
            switch (e.key) {
              case 'Enter':
                e.preventDefault();
                generatePalette();
                break;
              case '1':
                e.preventDefault();
                switchTab('text');
                break;
              case '2':
                e.preventDefault();
                switchTab('image');
                break;
            }
          }
        });
      }

      // Initialize Application
      function initializeApp() {
        // Set initial state
        switchTab('text');
        updateFullUIForColorBlindness('normal');
        
        // Load default palette
        const defaultColors = generateColorsFromPrompt('modern accessible design palette with high contrast ratios');
        state.isImageUpload = false;
        updatePalette(defaultColors);
        
        // Initialize all event listeners
        initializeEventListeners();
        
        console.log('🎨 ChromaGen with comprehensive WCAG analysis initialized successfully!');
      }

      // Start the application
      initializeApp();
      
    })();
  </script>
</body>
</html>
